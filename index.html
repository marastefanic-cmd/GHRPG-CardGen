<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloomhaven RPG Card Creator</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%235a5a5a'/%3E%3Cstop offset='50%25' stop-color='%233a3a3a'/%3E%3Cstop offset='100%25' stop-color='%234a4a4a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpolygon points='16,1 29,8.5 29,23.5 16,31 3,23.5 3,8.5' fill='url(%23g)' stroke='%23222' stroke-width='1'/%3E%3Crect x='10' y='7' width='12' height='18' rx='1.5' fill='%23b35a5a' stroke='%23222' stroke-width='0.5'/%3E%3Crect x='11' y='8' width='10' height='7' rx='0.5' fill='%23888'/%3E%3Cline x1='11' y1='17' x2='21' y2='17' stroke='%23222' stroke-width='0.5'/%3E%3Ccircle cx='16' cy='21' r='2' fill='%23333' stroke='%23555' stroke-width='0.3'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Pirata+One&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --gold: #8a7355;
            --gold-light: #c4b59d;
            --gold-dark: #5a4a35;
            --parchment: #e8e0d0;
            --parchment-dark: #d0c8b8;
            --ink: #2a2a2a;
            --ink-light: #4a4a4a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: linear-gradient(145deg, #1a1a24, #0d0d14);
            min-height: 100vh;
            padding: 30px;
            color: #e8e8e8;
        }

        h1 {
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--gold-light);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 30px;
            letter-spacing: 3px;
        }

        .layout {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: nowrap;
            max-width: 1800px;
            margin: 0 auto;
            align-items: flex-start;
        }

        /* Settings Panel (leftmost) */
        .settings-panel {
            background: linear-gradient(145deg, #252530, #1a1a24);
            border: 1px solid #3a3a45;
            border-radius: 12px;
            padding: 20px;
            width: 240px;
            flex-shrink: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .settings-panel h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gold-dark);
        }
        .settings-panel h3 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 0.9rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gold-dark);
        }
        .settings-panel h3.section-divider {
            margin-top: 18px;
        }
        .settings-panel .row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .settings-panel .field {
            flex: 1;
        }
        .settings-panel .field select,
        .settings-panel .field input[type="color"] {
            width: 100%;
            padding: 8px 10px;
            background: #0d0d14;
            border: 1px solid #3a3a45;
            border-radius: 6px;
            color: #fff;
            font-family: 'Crimson Text', serif;
            font-size: 14px;
        }
        .settings-panel .field select:focus {
            outline: none;
            border-color: var(--gold);
        }
        .settings-panel .field label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .settings-panel .field input[type="color"] {
            height: 36px;
            padding: 2px;
            cursor: pointer;
        }

        /* Editor Panel */
        .editor {
            background: linear-gradient(145deg, #252530, #1a1a24);
            border: 1px solid #3a3a45;
            border-radius: 12px;
            padding: 20px;
            width: 300px;
            flex-shrink: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* Icon Panel (rightmost) */
        .icon-panel {
            background: linear-gradient(145deg, #252530, #1a1a24);
            border: 1px solid #3a3a45;
            border-radius: 12px;
            padding: 20px;
            width: 280px;
            flex-shrink: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .icon-panel h3 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gold-dark);
        }

        /* AOE Panel (5th column) */
        .aoe-panel {
            background: linear-gradient(145deg, #252530, #1a1a24);
            border: 1px solid #3a3a45;
            border-radius: 12px;
            padding: 20px;
            width: 200px;
            flex-shrink: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .aoe-panel h3 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gold-dark);
        }
        .aoe-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .aoe-btn {
            background: #1a1a24;
            border: 1px solid #3a3a45;
            border-radius: 6px;
            cursor: pointer;
            padding: 8px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        .aoe-btn:hover {
            border-color: var(--gold);
            background: #252530;
        }
        .aoe-btn img {
            max-width: 100%;
            max-height: 50px;
            object-fit: contain;
        }
        .aoe-hint {
            font-size: 11px;
            color: #666;
            margin-top: 12px;
            font-style: italic;
        }
        .aoe-target-select {
            margin-bottom: 12px;
        }
        .aoe-target-select label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .aoe-target-select select {
            width: 100%;
            padding: 8px 10px;
            background: #0d0d14;
            border: 1px solid #3a3a45;
            border-radius: 6px;
            color: #fff;
            font-family: 'Crimson Text', serif;
            font-size: 14px;
        }

        /* Draggable AOE on card */
        .aoe-draggable {
            position: absolute;
            cursor: move;
            z-index: 5;
            user-select: none;
        }
        .aoe-draggable img {
            pointer-events: none;
            /* Scale so each hex is ~30px wide (single hex SVG is ~43px) */
            transform-origin: center center;
        }
        .aoe-draggable .aoe-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #a03020;
            border: 1px solid #c04030;
            border-radius: 50%;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s;
            pointer-events: auto;
        }
        .aoe-draggable:hover .aoe-remove {
            opacity: 1;
        }
        .aoe-draggable .aoe-rotate {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #2060a0;
            border: 1px solid #3080c0;
            border-radius: 50%;
            color: #fff;
            font-size: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s;
            pointer-events: auto;
        }
        .aoe-draggable:hover .aoe-rotate {
            opacity: 1;
        }
        .aoe-draggable .aoe-rotate:active {
            cursor: grabbing;
        }
        .card-container {
            position: relative;
        }

        /* AOE Container in ability sections */
        .aoe-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .aoe-container .aoe-draggable {
            pointer-events: auto;
        }

        .editor h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gold-dark);
        }

        .field { margin-bottom: 14px; }
        .field label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .field input, .field select, .field textarea {
            width: 100%;
            padding: 10px 12px;
            background: #0d0d14;
            border: 1px solid #3a3a45;
            border-radius: 6px;
            color: #fff;
            font-family: 'Crimson Text', serif;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            outline: none;
            border-color: var(--gold);
        }
        .field textarea { height: 70px; resize: vertical; line-height: 1.4; }
        .field textarea#flavor { height: 50px; }

        /* Text formatting toolbar */
        .format-toolbar {
            display: flex;
            gap: 4px;
            margin-bottom: 5px;
            align-items: center;
        }
        .format-btn {
            width: 26px;
            height: 26px;
            background: #1a1a24;
            border: 1px solid #3a3a45;
            border-radius: 4px;
            color: #aaa;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-family: 'Crimson Text', serif;
        }
        .format-btn:hover {
            background: #252530;
            border-color: var(--gold);
            color: #fff;
        }
        .format-btn.bold { font-weight: bold; }
        .format-btn.italic { font-style: italic; }
        .format-size {
            width: 50px;
            height: 26px;
            background: #1a1a24;
            border: 1px solid #3a3a45;
            border-radius: 4px;
            color: #aaa;
            font-size: 11px;
            padding: 0 6px;
            cursor: pointer;
        }
        .format-size:focus {
            outline: none;
            border-color: var(--gold);
        }
        .ability-toggles { display: flex; gap: 12px; margin-top: 6px; }
        .toggle-label { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #aaa; cursor: pointer; }
        .toggle-label input { cursor: pointer; }
        .field input.small { width: 70px; text-align: center; }
        .field input[type="color"] {
            width: 100%;
            height: 36px;
            padding: 2px;
            border: 1px solid #3a3a45;
            border-radius: 6px;
            background: #0d0d14;
            cursor: pointer;
        }
        .field input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }
        .field input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }
        .row { display: flex; gap: 12px; }
        .row .field { flex: 1; }

        .row-3 { display: flex; gap: 10px; align-items: flex-end; }
        .row-3 .field { flex: 1; }
        .row-3 .field.small { flex: 0 0 70px; }

        /* Icon Palette */
        .icon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .icon-btn {
            width: 38px;
            height: 38px;
            background: #1a1a24;
            border: 1px solid #3a3a45;
            border-radius: 5px;
            cursor: pointer;
            padding: 7px;
            transition: all 0.15s;
        }
        .icon-btn:hover {
            border-color: var(--gold);
            background: #252530;
        }
        .icon-btn img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .icon-hint {
            font-size: 11px;
            color: #666;
            margin-top: 12px;
            font-style: italic;
        }

        .btn {
            flex: 1;
            padding: 11px;
            border: none;
            border-radius: 6px;
            font-family: 'Cinzel', serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-gold {
            background: linear-gradient(145deg, var(--gold), var(--gold-dark));
            color: #fff;
            box-shadow: 0 4px 15px rgba(138,115,85,0.3);
        }
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(138,115,85,0.4);
        }
        .btn-dark {
            background: linear-gradient(145deg, #3a3a45, #2a2a35);
            color: #999;
        }
        .btn-dark:hover { color: #fff; }

        /* ==================== CENTER COLUMN ==================== */
        .preview-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .preview-actions {
            display: flex;
            gap: 12px;
        }

        .preview-actions .btn {
            padding: 12px 28px;
            flex: none;
        }

        /* ==================== CARD DESIGN - GLOOMHAVEN STYLE ==================== */
        .card-container {
            flex-shrink: 0;
        }
        .card {
            width: 320px;
            height: 423px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.7);
        }

        /* Stone frame - single continuous element with integrated bulges */
        .card-frame {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            border-radius: 6px;
        }
        /* Frame with integrated bulges - uses SVG mask for complex shape */
        .card-frame::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--frame-gradient, linear-gradient(180deg,
                rgba(89,89,89,1) 0%,
                rgba(61,61,61,1) 15%,
                rgba(48,48,48,1) 50%,
                rgba(61,61,61,1) 85%,
                rgba(69,69,69,1) 100%
            ));
            /* SVG mask: outer rect minus inner rect with bulge indentations
               Card: 320x423, Frame: 10px top/bottom, 8px sides, Bulge: +9px inward
               Bulge at 10%-90% height (42.3-380.7px), diagonal ~10.7px to match bar slope */
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 423'%3E%3Cdefs%3E%3Cmask id='m'%3E%3Crect width='320' height='423' fill='white'/%3E%3Cpath d='M8 10 L8 42.3 L17 53 L17 370 L8 380.7 L8 413 L312 413 L312 380.7 L303 370 L303 53 L312 42.3 L312 10 Z' fill='black'/%3E%3C/mask%3E%3C/defs%3E%3Crect width='320' height='423' mask='url(%23m)'/%3E%3C/svg%3E");
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 423'%3E%3Cdefs%3E%3Cmask id='m'%3E%3Crect width='320' height='423' fill='white'/%3E%3Cpath d='M8 10 L8 42.3 L17 53 L17 370 L8 380.7 L8 413 L312 413 L312 380.7 L303 370 L303 53 L312 42.3 L312 10 Z' fill='black'/%3E%3C/mask%3E%3C/defs%3E%3Crect width='320' height='423' mask='url(%23m)'/%3E%3C/svg%3E");
            -webkit-mask-size: 100% 100%;
            mask-size: 100% 100%;
        }
        /* Bulge elements no longer needed - kept for backwards compatibility but hidden */
        .card-frame-bulge-left,
        .card-frame-bulge-right {
            display: none;
        }
        /* We no longer need separate stone-top, stone-bottom, or corner elements */
        .card-stone-top,
        .card-stone-bottom,
        .card-corner-tl,
        .card-corner-tr,
        .card-corner-bl,
        .card-corner-br {
            display: none;
        }

        /* Colored side accent bars - layered on TOP of the gray frame */
        .card-side-accents {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 11;
        }
        /* Left colored bar - uses header color */
        .card-side-left {
            position: absolute;
            left: 0;
            top: 10%;
            bottom: 10%;
            width: 12px;
            background: linear-gradient(180deg,
                var(--class-header-light, #808080) 0%,
                var(--class-header-dark, #606060) 100%
            );
            box-shadow:
                inset -2px 0 4px rgba(0,0,0,0.5),
                inset 1px 0 2px rgba(255,255,255,0.1);
            z-index: 11;
            /* Diagonal edges: outer edge straight, inner edge angled */
            clip-path: polygon(0 0, 100% 4%, 100% 96%, 0 100%);
        }
        /* Right colored bar - uses header color */
        .card-side-right {
            position: absolute;
            right: 0;
            top: 10%;
            bottom: 10%;
            width: 12px;
            background: linear-gradient(180deg,
                var(--class-header-light, #808080) 0%,
                var(--class-header-dark, #606060) 100%
            );
            box-shadow:
                inset 2px 0 4px rgba(0,0,0,0.5),
                inset -1px 0 2px rgba(255,255,255,0.1);
            z-index: 11;
            /* Diagonal edges: inner edge angled, outer edge straight */
            clip-path: polygon(0 4%, 100% 0, 100% 100%, 0 96%);
        }

        /* Card inner background - base color, sections handle light/dark split */
        .card-bg {
            position: absolute;
            inset: 10px 8px;
            background: var(--class-dark);
        }

        /* Mottled texture mask - creates cloudy/smoky spots like official cards */
        .card-texture {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.4;
            background:
                /* Large cloudy dark spots */
                radial-gradient(ellipse 80% 60% at 15% 20%, rgba(0,0,0,0.4) 0%, transparent 50%),
                radial-gradient(ellipse 70% 80% at 85% 75%, rgba(0,0,0,0.35) 0%, transparent 45%),
                radial-gradient(ellipse 60% 50% at 75% 15%, rgba(0,0,0,0.3) 0%, transparent 40%),
                radial-gradient(ellipse 50% 70% at 25% 85%, rgba(0,0,0,0.35) 0%, transparent 45%),
                /* Medium cloudy spots */
                radial-gradient(ellipse 40% 35% at 50% 40%, rgba(0,0,0,0.25) 0%, transparent 50%),
                radial-gradient(ellipse 35% 40% at 30% 60%, rgba(0,0,0,0.2) 0%, transparent 45%),
                radial-gradient(ellipse 45% 30% at 70% 50%, rgba(0,0,0,0.2) 0%, transparent 50%),
                /* Lighter highlight spots */
                radial-gradient(ellipse 50% 40% at 40% 25%, rgba(255,255,255,0.08) 0%, transparent 40%),
                radial-gradient(ellipse 40% 50% at 60% 70%, rgba(255,255,255,0.06) 0%, transparent 35%),
                /* Vignette - darker edges */
                radial-gradient(ellipse 100% 100% at 50% 50%, transparent 40%, rgba(0,0,0,0.3) 100%);
            mix-blend-mode: multiply;
        }

        /* Noise texture overlay for fine grain */
        .card-overlay {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.12;
            mix-blend-mode: overlay;
            pointer-events: none;
        }

        /* Class color schemes - saturated colors matching official Gloomhaven cards */
        /* Each class has: side bar color, header colors, background tints */
        .card.bruiser {
            --class-light: #5a8ab0; --class-mid: #3a6a90; --class-dark: #1a3a50;
            --class-side: #4a7aa0; --class-header-light: #6090b0; --class-header-dark: #3a6080;
        }
        .card.tinkerer {
            --class-light: #a08060; --class-mid: #806040; --class-dark: #4a3020;
            --class-side: #907050; --class-header-light: #b09070; --class-header-dark: #705030;
        }
        .card.spellweaver {
            --class-light: #9060a0; --class-mid: #6a3a7a; --class-dark: #3a1a4a;
            --class-side: #8050a0; --class-header-light: #a070b0; --class-header-dark: #603080;
        }
        .card.silent_knife {
            --class-light: #70b070; --class-mid: #408040; --class-dark: #1a4a1a;
            --class-side: #50a050; --class-header-light: #80c080; --class-header-dark: #306030;
        }
        .card.cragheart {
            --class-light: #8a7060; --class-mid: #6a5040; --class-dark: #3a2a1a;
            --class-side: #7a6050; --class-header-light: #9a8070; --class-header-dark: #5a4030;
        }
        .card.mindthief {
            --class-light: #5a7090; --class-mid: #3a5070; --class-dark: #1a2a40;
            --class-side: #4a6080; --class-header-light: #6a80a0; --class-header-dark: #3a5060;
        }
        .card.sun {
            --class-light: #d0a050; --class-mid: #a07030; --class-dark: #604010;
            --class-side: #c09040; --class-header-light: #e0b060; --class-header-dark: #906020;
        }
        .card.music_note {
            --class-light: #c070a0; --class-mid: #904070; --class-dark: #502040;
            --class-side: #b06090; --class-header-light: #d080b0; --class-header-dark: #803060;
        }
        .card.cthulhu {
            --class-light: #50a0a0; --class-mid: #307070; --class-dark: #104040;
            --class-side: #409090; --class-header-light: #60b0b0; --class-header-dark: #206060;
        }
        .card.three_spears {
            --class-light: #b08050; --class-mid: #905a30; --class-dark: #503010;
            --class-side: #a07040; --class-header-light: #c09060; --class-header-dark: #804a20;
        }
        .card.lightning_bolts {
            --class-light: #70a0c0; --class-mid: #4070a0; --class-dark: #103060;
            --class-side: #5090b0; --class-header-light: #80b0d0; --class-header-dark: #306090;
        }
        .card.angry_face {
            --class-light: #90b0c0; --class-mid: #607080; --class-dark: #304050;
            --class-side: #7090a0; --class-header-light: #a0c0d0; --class-header-dark: #506070;
        }
        .card.saw {
            --class-light: #a0a0a0; --class-mid: #707070; --class-dark: #404040;
            --class-side: #909090; --class-header-light: #b0b0b0; --class-header-dark: #606060;
        }
        .card.triangles {
            --class-light: #c0a060; --class-mid: #907030; --class-dark: #504010;
            --class-side: #b09050; --class-header-light: #d0b070; --class-header-dark: #806020;
        }
        .card.two_minis {
            --class-light: #80a080; --class-mid: #507050; --class-dark: #204020;
            --class-side: #609060; --class-header-light: #90b090; --class-header-dark: #406040;
        }
        .card.crossed_swords {
            --class-light: #c08070; --class-mid: #905040; --class-dark: #502010;
            --class-side: #b07060; --class-header-light: #d09080; --class-header-dark: #804030;
        }
        .card.custom {
            --class-light: #6a7a8a; --class-mid: #4a5a6a; --class-dark: #2a3a4a;
            --class-side: #5a6a7a; --class-header-light: #7a8a9a; --class-header-dark: #3a4a5a;
        }

        .card-content {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 6;
            padding: 18px 12px 18px 12px;
        }

        /* Header section - class-colored banner style like real cards */
        .card-header {
            background: linear-gradient(180deg,
                var(--class-header-light, #b0b0b0) 0%,
                var(--class-header-light, #808080) 15%,
                var(--class-header-dark, #606060) 85%,
                var(--class-header-dark, #404040) 100%);
            border-radius: 0;
            padding: 6px 10px;
            margin: -10px -12px 0 -12px;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.25),
                inset 0 -1px 0 rgba(0,0,0,0.3);
        }

        .header-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Level indicator - hexagonal style in top-left */
        .level-hex {
            width: 26px;
            height: 26px;
            background: var(--hex-rim, linear-gradient(180deg, #6a7a8a 0%, #4a5a6a 50%, #3a4a5a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }
        .level-hex::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--hex-inner, linear-gradient(180deg, #3a4a5a 0%, #1a2a3a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .level-hex span {
            position: relative;
            font-family: 'Pirata One', 'Cinzel', serif;
            font-size: 12px;
            font-weight: 400;
            color: #fff;
            text-shadow: 1px 1px 1px #000;
            z-index: 1;
        }

        /* Card name */
        .name-banner {
            flex: 1;
            text-align: center;
        }
        .card-name {
            font-family: 'Pirata One', 'Cinzel', serif;
            font-size: 19px;
            font-weight: 400;
            color: #1a1a1a;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
            letter-spacing: 1px;
        }

        /* Class icon placeholder */
        .class-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .class-icon img {
            width: 80%;
            height: 80%;
            filter: brightness(0) drop-shadow(1px 1px 1px rgba(0,0,0,0.5));
        }

        /* Flavor text - below header, slightly lighter than top action */
        .flavor-text {
            padding: 8px 22px;
            margin: 0 -12px;
            text-align: center;
            font-family: 'Lora', 'Crimson Text', serif;
            font-style: italic;
            font-size: 10px;
            color: rgba(255,255,255,0.8);
            line-height: 1.3;
            flex-shrink: 0;
            background: var(--class-mid);
            position: relative;
        }
        .flavor-text:empty,
        .flavor-text.hidden {
            display: none;
        }

        /* Ability sections */
        .ability-section {
            flex: 1;
            min-height: 0;
            padding: 12px 22px;
            margin: 0 -12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .ability-section.top {
            background:
                radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 50%, rgba(255,255,255,0.06) 0%, transparent 40%),
                var(--class-light);
            border-top: 1px solid var(--class-header-dark, #606060);
        }
        .ability-section.bottom {
            background:
                radial-gradient(ellipse at 50% 70%, rgba(0,0,0,0.15) 0%, transparent 50%),
                var(--class-dark);
            margin-bottom: -10px;
        }
        /* Only show separator above top action when flavor text is visible */
        .flavor-text.hidden + .ability-section.top,
        .flavor-text:empty + .ability-section.top {
            border-top: none;
        }

        .ability-indicator {
            position: absolute;
            bottom: 0px;
            height: 22px;
            display: none;
            object-fit: contain;
        }
        .ability-indicator.loss {
            width: 22px;
        }
        .ability-indicator.round-bonus {
            width: 44px;
        }
        .ability-indicator.persistent {
            width: 36px;
        }
        .ability-indicator.visible {
            display: block;
        }

        .ability-text {
            font-family: 'Lora', 'Crimson Text', serif;
            font-size: 14px;
            line-height: 1.5;
            color: #ffffff;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .ability-text span {
            display: block;
        }
        .ability-text .stat-num {
            font-family: 'Pirata One', serif;
            display: inline;
            font-size: 1.1em;
        }

        /* Initiative section - horizontal divider with hexagon */
        .initiative-section {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            margin: 0 -12px;
            position: relative;
            background: linear-gradient(180deg, var(--class-light) 0%, var(--class-light) 50%, var(--class-dark) 50%, var(--class-dark) 100%);
        }

        /* Divider lines - thin lines matching header color */
        .initiative-section::before,
        .initiative-section::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--class-header-dark, #606060);
        }

        .side-value {
            width: 32px;
            height: 36px;
            background: var(--hex-rim, linear-gradient(180deg, #6a7a8a 0%, #4a5a6a 50%, #3a4a5a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Pirata One', 'Cinzel', serif;
            font-size: 12px;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 2px #000;
            position: relative;
        }
        .side-value::before {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--hex-inner, linear-gradient(180deg, #3a4a5a 0%, #1a2a3a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .side-value span {
            position: relative;
            z-index: 1;
        }
        .side-value img {
            width: 14px;
            height: 14px;
            position: relative;
            z-index: 1;
        }

        /* Hexagonal initiative */
        .initiative-main {
            width: 52px;
            height: 52px;
            background: var(--hex-rim, linear-gradient(180deg, #6a7a8a 0%, #4a5a6a 50%, #3a4a5a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 8px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .initiative-main::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: var(--hex-inner, linear-gradient(180deg, #3a4a5a 0%, #1a2a3a 100%));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        .initiative-value {
            position: relative;
            font-family: 'Pirata One', 'Cinzel', serif;
            font-size: 24px;
            font-weight: 400;
            color: #fff;
            text-shadow: 2px 2px 4px #000;
            z-index: 1;
        }

        /* ==================== COLLECTION ==================== */
        .collection-section {
            width: 100%;
            max-width: 1200px;
            margin: 50px auto 0;
            background: linear-gradient(145deg, #1a1a24, #151518);
            border: 1px solid #3a3a45;
            border-radius: 12px;
            padding: 25px;
        }

        .collection-section h2 {
            font-family: 'Cinzel', serif;
            color: var(--gold-light);
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .card-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            min-height: 100px;
        }

        .card-wrapper {
            position: relative;
        }

        /* Collection cards - scaled down Gloomhaven style */
        .card-grid .card {
            width: 190px;
            height: 251px;
            border-radius: 5px;
        }
        .card-grid .card-frame {
            border-radius: 4px;
        }
        .card-grid .card-frame::before {
            border-radius: 4px;
        }
        .card-grid .card-side-left {
            width: 7px;
            top: 10%;
            bottom: 10%;
        }
        .card-grid .card-side-right {
            width: 7px;
            top: 10%;
            bottom: 10%;
        }
        .card-grid .card-bg,
        .card-grid .card-texture,
        .card-grid .card-overlay {
            inset: 0;
        }
        .card-grid .card-content {
            padding: 11px 8px 11px 8px;
        }
        .card-grid .card-header {
            padding: 4px 6px;
            margin: -6px -8px 0 -8px;
        }
        .card-grid .level-hex {
            width: 16px;
            height: 16px;
        }
        .card-grid .level-hex::before {
            inset: 1px;
        }
        .card-grid .level-hex span {
            font-size: 8px;
        }
        .card-grid .card-name {
            font-size: 9px;
        }
        .card-grid .class-icon {
            width: 14px;
            height: 14px;
        }
        .card-grid .flavor-text {
            padding: 4px 14px;
            margin: 0 -8px;
            font-size: 5px;
        }
        .card-grid .ability-section {
            padding: 6px 13px;
            margin: 0 -8px;
        }
        .card-grid .ability-section.top {
            border-top-width: 1px;
        }
        .card-grid .ability-section.bottom {
            margin-bottom: -6px;
        }
        .card-grid .ability-text {
            font-size: 8px;
            line-height: 1.3;
        }
        .card-grid .ability-indicator {
            height: 13px;
        }
        .card-grid .ability-indicator.loss {
            width: 13px;
        }
        .card-grid .ability-indicator.round-bonus {
            width: 26px;
        }
        .card-grid .ability-indicator.persistent {
            width: 21px;
        }
        .card-grid .initiative-section {
            padding: 2px 8px;
            margin: 0 -8px;
        }
        .card-grid .initiative-section::before,
        .card-grid .initiative-section::after {
            height: 1px;
        }
        .card-grid .side-value {
            width: 20px;
            height: 22px;
            font-size: 8px;
        }
        .card-grid .side-value::before {
            inset: 1px;
        }
        .card-grid .side-value img {
            width: 10px;
            height: 10px;
        }
        .card-grid .initiative-main {
            width: 32px;
            height: 32px;
            margin: 0 4px;
        }
        .card-grid .initiative-main::before {
            inset: 2px;
        }
        .card-grid .initiative-value {
            font-size: 14px;
        }

        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 26px;
            height: 26px;
            background: linear-gradient(145deg, #a03020, #702010);
            border: 2px solid #c04030;
            border-radius: 50%;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            transition: transform 0.15s;
        }
        .remove-btn:hover { transform: scale(1.1); }

        .empty-state {
            color: #555;
            text-align: center;
            padding: 40px;
            font-style: italic;
        }

        .collection-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        .collection-buttons .btn { flex: none; padding: 12px 30px; }

        /* ==================== SUMMON STYLES ==================== */
        .summon-config {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #1a1a24;
            border: 1px solid #3a3a45;
            border-radius: 6px;
        }
        .summon-config.visible {
            display: block;
        }
        .summon-config .field {
            margin-bottom: 10px;
        }
        .summon-config .field:last-child {
            margin-bottom: 0;
        }
        .summon-stats-row {
            display: flex;
            gap: 8px;
        }
        .summon-stats-row .field {
            flex: 1;
        }
        .summon-stats-row input {
            width: 100%;
            text-align: center;
        }
        .summon-image-preview {
            width: 60px;
            height: 60px;
            background: #2a2a35;
            border: 1px solid #3a3a45;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-top: 5px;
        }
        .summon-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .summon-image-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .summon-image-row .field {
            flex: 1;
        }

        /* Summon box on card */
        .summon-header {
            font-family: 'Crimson Text', serif;
            font-size: 13px;
            color: #ffffff;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            margin-bottom: 6px;
        }
        .summon-box {
            display: none;
            background: linear-gradient(180deg, rgba(30,50,60,0.95) 0%, rgba(20,35,45,0.95) 100%);
            border: 2px solid rgba(100,140,160,0.6);
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .summon-box.visible {
            display: block;
        }
        .summon-content {
            display: flex;
            gap: 6px;
            align-items: stretch;
        }
        .summon-portrait {
            width: 55px;
            height: 55px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(100,140,160,0.4);
            border-radius: 3px;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summon-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .summon-stats {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(100,140,160,0.3);
            border-radius: 2px;
            padding: 3px;
        }
        .summon-stat {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 3px;
            padding: 2px 4px;
            background: rgba(30,50,60,0.5);
            border-radius: 2px;
        }
        .summon-stat img {
            width: 14px;
            height: 14px;
            filter: brightness(1.2);
        }
        .summon-stat span {
            font-family: 'Crimson Text', serif;
            font-size: 13px;
            color: #ffffff;
            font-weight: 600;
        }
        .summon-special {
            width: 55px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            font-family: 'Crimson Text', serif;
            font-size: 9px;
            color: rgba(255,255,255,0.9);
            text-align: center;
            line-height: 1.2;
        }
        .summon-extra-text {
            font-family: 'Crimson Text', serif;
            font-size: 12px;
            color: #ffffff;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            margin-top: 6px;
            line-height: 1.3;
        }

        /* Collection view summon scaling */
        .card-grid .summon-header {
            font-size: 8px;
            margin-bottom: 3px;
        }
        .card-grid .summon-box {
            padding: 3px;
            margin: 2px 0;
            border-width: 1px;
        }
        .card-grid .summon-content {
            gap: 3px;
        }
        .card-grid .summon-portrait {
            width: 32px;
            height: 32px;
        }
        .card-grid .summon-stats {
            gap: 1px;
            padding: 2px;
        }
        .card-grid .summon-stat {
            padding: 1px 2px;
            gap: 2px;
        }
        .card-grid .summon-stat img {
            width: 8px;
            height: 8px;
        }
        .card-grid .summon-stat span {
            font-size: 8px;
        }
        .card-grid .summon-special {
            width: 32px;
            font-size: 6px;
        }
        .card-grid .summon-extra-text {
            font-size: 7px;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <h1>Gloomhaven RPG Card Creator</h1>

    <div class="layout">
        <!-- Column 1: Settings Panel -->
        <div class="settings-panel">
            <h2>Card Settings</h2>
            <div class="row">
                <div class="field">
                    <label>Class</label>
                    <select id="classSelect">
                        <option value="custom">Custom</option>
                        <option value="bruiser">Bruiser</option>
                        <option value="tinkerer">Tinkerer</option>
                        <option value="spellweaver">Spellweaver</option>
                        <option value="silent_knife">Silent Knife</option>
                        <option value="cragheart">Cragheart</option>
                        <option value="mindthief">Mindthief</option>
                        <option value="sun">Sun</option>
                        <option value="three_spears">Three Spears</option>
                        <option value="cthulhu">Cthulhu</option>
                        <option value="lightning_bolts">Lightning Bolts</option>
                        <option value="music_note">Music Note</option>
                        <option value="angry_face">Angry Face</option>
                        <option value="saw">Saw</option>
                        <option value="triangles">Triangles</option>
                        <option value="two_minis">Two Minis</option>
                        <option value="crossed_swords">Crossed Swords</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Level</label>
                    <select id="level">
                        <option>1</option><option>2</option><option>3</option>
                        <option>4</option><option>5</option><option>6</option>
                        <option>7</option><option>8</option><option>9</option>
                        <option>X</option>
                    </select>
                </div>
            </div>

            <h3 class="section-divider">Colors</h3>
            <div class="row">
                <div class="field">
                    <label>Header</label>
                    <input type="color" id="colorHeader" value="#808080">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Flavor Text</label>
                    <input type="color" id="colorFlavor" value="#3a4a56">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Top Action</label>
                    <input type="color" id="colorTopAction" value="#4a5a6a">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Bottom Action</label>
                    <input type="color" id="colorBottomAction" value="#1a2a3a">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Hex Inner</label>
                    <input type="color" id="colorHexInner" value="#2a3a4a">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Hex Rim</label>
                    <input type="color" id="colorHexRim" value="#5a6a7a">
                </div>
            </div>
            <div class="row">
                <div class="field">
                    <label>Frame</label>
                    <input type="color" id="colorFrame" value="#4a4a4a">
                </div>
            </div>
        </div>

        <!-- Column 2: Card Editor -->
        <div class="editor">
            <h2>Card Editor</h2>

            <div class="field">
                <label>Card Name</label>
                <input type="text" id="name" placeholder="e.g. Powerful Leap">
            </div>

            <div class="field">
                <label>Flavor Text</label>
                <div class="format-toolbar">
                    <button type="button" class="format-btn bold" onclick="formatText('flavor', 'b')" title="Bold">B</button>
                    <button type="button" class="format-btn italic" onclick="formatText('flavor', 'i')" title="Italic">I</button>
                    <select class="format-size" onchange="formatSize('flavor', this.value); this.value='';" title="Font Size">
                        <option value="">Size</option>
                        <option value="10">10px</option>
                        <option value="12">12px</option>
                        <option value="14">14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                    </select>
                </div>
                <textarea id="flavor" placeholder="e.g. You bound into the sky..." rows="2"></textarea>
            </div>

            <div class="field">
                <label>Top Ability</label>
                <div class="format-toolbar">
                    <button type="button" class="format-btn bold" onclick="formatText('top', 'b')" title="Bold">B</button>
                    <button type="button" class="format-btn italic" onclick="formatText('top', 'i')" title="Italic">I</button>
                    <select class="format-size" onchange="formatSize('top', this.value); this.value='';" title="Font Size">
                        <option value="">Size</option>
                        <option value="12">12px</option>
                        <option value="14">14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>
                <textarea id="top" placeholder="Top action..."></textarea>
                <div class="ability-toggles">
                    <label class="toggle-label"><input type="checkbox" id="topLoss" onchange="update()"> Loss</label>
                    <label class="toggle-label"><input type="checkbox" id="topRoundBonus" onchange="toggleBonus('top', 'RoundBonus')"> Round Bonus</label>
                    <label class="toggle-label"><input type="checkbox" id="topPersistent" onchange="toggleBonus('top', 'Persistent')"> Persistent</label>
                    <label class="toggle-label"><input type="checkbox" id="topSummon" onchange="toggleSummon('top')"> Summon</label>
                </div>
                <div class="summon-config" id="topSummonConfig">
                    <div class="summon-image-row">
                        <div class="field">
                            <label>Summon Name</label>
                            <input type="text" id="topSummonName" placeholder="e.g. Vicious Jackal">
                        </div>
                        <div>
                            <label>Portrait</label>
                            <input type="file" id="topSummonImage" accept="image/*" style="display:none" onchange="handleSummonImage('top')">
                            <button type="button" class="btn btn-dark" onclick="document.getElementById('topSummonImage').click()" style="padding:6px 10px;font-size:10px;">Upload</button>
                            <div class="summon-image-preview" id="topSummonImagePreview"></div>
                        </div>
                    </div>
                    <div class="summon-stats-row">
                        <div class="field">
                            <label>HP</label>
                            <input type="text" id="topSummonHP" placeholder="4">
                        </div>
                        <div class="field">
                            <label>Move</label>
                            <input type="text" id="topSummonMove" placeholder="3">
                        </div>
                        <div class="field">
                            <label>Attack</label>
                            <input type="text" id="topSummonAttack" placeholder="2">
                        </div>
                        <div class="field">
                            <label>Range</label>
                            <input type="text" id="topSummonRange" placeholder="-">
                        </div>
                    </div>
                    <div class="field">
                        <label>Special Text (sidebar)</label>
                        <input type="text" id="topSummonSpecial" placeholder="e.g. Unaffected by difficult terrain">
                    </div>
                    <div class="field">
                        <label>Extra Text (below summon box)</label>
                        <textarea id="topSummonExtra" placeholder="e.g. This enemy suffers [poison] 1 at the start of each of its turns." rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="row-3">
                <div class="field small">
                    <label>Left #</label>
                    <input type="text" id="leftVal" placeholder="+1" class="small">
                </div>
                <div class="field">
                    <label>Initiative</label>
                    <input type="number" id="initiative" min="1" max="99" value="20">
                </div>
                <div class="field small">
                    <label>Right #</label>
                    <input type="text" id="rightVal" placeholder="2" class="small">
                </div>
            </div>

            <div class="field">
                <label>Bottom Ability</label>
                <div class="format-toolbar">
                    <button type="button" class="format-btn bold" onclick="formatText('bottom', 'b')" title="Bold">B</button>
                    <button type="button" class="format-btn italic" onclick="formatText('bottom', 'i')" title="Italic">I</button>
                    <select class="format-size" onchange="formatSize('bottom', this.value); this.value='';" title="Font Size">
                        <option value="">Size</option>
                        <option value="12">12px</option>
                        <option value="14">14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                        <option value="20">20px</option>
                    </select>
                </div>
                <textarea id="bottom" placeholder="Bottom action..."></textarea>
                <div class="ability-toggles">
                    <label class="toggle-label"><input type="checkbox" id="bottomLoss" onchange="update()"> Loss</label>
                    <label class="toggle-label"><input type="checkbox" id="bottomRoundBonus" onchange="toggleBonus('bottom', 'RoundBonus')"> Round Bonus</label>
                    <label class="toggle-label"><input type="checkbox" id="bottomPersistent" onchange="toggleBonus('bottom', 'Persistent')"> Persistent</label>
                    <label class="toggle-label"><input type="checkbox" id="bottomSummon" onchange="toggleSummon('bottom')"> Summon</label>
                </div>
                <div class="summon-config" id="bottomSummonConfig">
                    <div class="summon-image-row">
                        <div class="field">
                            <label>Summon Name</label>
                            <input type="text" id="bottomSummonName" placeholder="e.g. Vicious Jackal">
                        </div>
                        <div>
                            <label>Portrait</label>
                            <input type="file" id="bottomSummonImage" accept="image/*" style="display:none" onchange="handleSummonImage('bottom')">
                            <button type="button" class="btn btn-dark" onclick="document.getElementById('bottomSummonImage').click()" style="padding:6px 10px;font-size:10px;">Upload</button>
                            <div class="summon-image-preview" id="bottomSummonImagePreview"></div>
                        </div>
                    </div>
                    <div class="summon-stats-row">
                        <div class="field">
                            <label>HP</label>
                            <input type="text" id="bottomSummonHP" placeholder="4">
                        </div>
                        <div class="field">
                            <label>Move</label>
                            <input type="text" id="bottomSummonMove" placeholder="3">
                        </div>
                        <div class="field">
                            <label>Attack</label>
                            <input type="text" id="bottomSummonAttack" placeholder="2">
                        </div>
                        <div class="field">
                            <label>Range</label>
                            <input type="text" id="bottomSummonRange" placeholder="-">
                        </div>
                    </div>
                    <div class="field">
                        <label>Special Text (sidebar)</label>
                        <input type="text" id="bottomSummonSpecial" placeholder="e.g. Unaffected by difficult terrain">
                    </div>
                    <div class="field">
                        <label>Extra Text (below summon box)</label>
                        <textarea id="bottomSummonExtra" placeholder="e.g. This enemy suffers [poison] 1 at the start of each of its turns." rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="preview-column">
            <div class="preview-actions">
                <button class="btn btn-gold" onclick="addCard()">Add Card</button>
                <button class="btn btn-dark" onclick="clearForm()">Clear</button>
            </div>
            <div class="card-container">
            <div class="card custom" id="preview">
                <div class="card-bg" id="pCardBg"></div>
                <div class="card-texture"></div>
                <div class="card-overlay"></div>
                <div class="card-frame"></div>
                <div class="card-frame-bulge-left"></div>
                <div class="card-frame-bulge-right"></div>
                <!-- Colored side bars -->
                <div class="card-side-left"></div>
                <div class="card-side-right"></div>
                <div class="card-content">
                    <div class="card-header">
                        <div class="header-row">
                            <div class="level-hex"><span id="pLevel">1</span></div>
                            <div class="name-banner" id="pBanner">
                                <div class="card-name" id="pName">Card Name</div>
                            </div>
                            <div class="class-icon" id="pClassIcon"></div>
                        </div>
                    </div>
                    <div class="flavor-text" id="pFlavor">Flavor text appears here...</div>

                    <div class="ability-section top">
                        <div class="summon-header" id="pTopSummonHeader"></div>
                        <div class="summon-box" id="pTopSummonBox">
                            <div class="summon-content">
                                <div class="summon-portrait" id="pTopSummonPortrait"></div>
                                <div class="summon-stats">
                                    <div class="summon-stat"><img src="assets/assets/heal.svg" alt="HP"><span id="pTopSummonHP">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/move.svg" alt="Move"><span id="pTopSummonMove">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/attack.svg" alt="Attack"><span id="pTopSummonAttack">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/range.svg" alt="Range"><span id="pTopSummonRange">-</span></div>
                                </div>
                                <div class="summon-special" id="pTopSummonSpecial"></div>
                            </div>
                        </div>
                        <div class="summon-extra-text" id="pTopSummonExtra"></div>
                        <div class="ability-text" id="pTop"></div>
                        <div class="aoe-container" id="pTopAoeContainer"></div>
                        <img class="ability-indicator loss" id="pTopLoss" src="assets/assets/lost.png" alt="loss">
                        <img class="ability-indicator round-bonus" id="pTopRoundBonus" src="assets/assets/round_bonus.png" alt="round bonus">
                        <img class="ability-indicator persistent" id="pTopPersistent" src="assets/assets/persistent_bonus.png" alt="persistent">
                    </div>

                    <div class="initiative-section">
                        <div class="side-value" id="pLeftBox"><span id="pLeft"></span></div>
                        <div class="initiative-main" id="pInitBox">
                            <span class="initiative-value" id="pInit">20</span>
                        </div>
                        <div class="side-value" id="pRightBox"><span id="pRight"></span></div>
                    </div>

                    <div class="ability-section bottom">
                        <div class="summon-header" id="pBottomSummonHeader"></div>
                        <div class="summon-box" id="pBottomSummonBox">
                            <div class="summon-content">
                                <div class="summon-portrait" id="pBottomSummonPortrait"></div>
                                <div class="summon-stats">
                                    <div class="summon-stat"><img src="assets/assets/heal.svg" alt="HP"><span id="pBottomSummonHP">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/move.svg" alt="Move"><span id="pBottomSummonMove">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/attack.svg" alt="Attack"><span id="pBottomSummonAttack">-</span></div>
                                    <div class="summon-stat"><img src="assets/assets/range.svg" alt="Range"><span id="pBottomSummonRange">-</span></div>
                                </div>
                                <div class="summon-special" id="pBottomSummonSpecial"></div>
                            </div>
                        </div>
                        <div class="summon-extra-text" id="pBottomSummonExtra"></div>
                        <div class="ability-text" id="pBottom"></div>
                        <div class="aoe-container" id="pBottomAoeContainer"></div>
                        <img class="ability-indicator loss" id="pBottomLoss" src="assets/assets/lost.png" alt="loss">
                        <img class="ability-indicator round-bonus" id="pBottomRoundBonus" src="assets/assets/round_bonus.png" alt="round bonus">
                        <img class="ability-indicator persistent" id="pBottomPersistent" src="assets/assets/persistent_bonus.png" alt="persistent">
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Column 4: Icon Panel -->
        <div class="icon-panel">
            <h3>Insert Icons</h3>
            <div class="icon-grid" id="iconGrid"></div>
            <p class="icon-hint">Click a text field first, then click an icon to insert it.</p>
        </div>

        <!-- Column 5: AOE Panel -->
        <div class="aoe-panel">
            <h3>Area of Effect</h3>
            <div class="aoe-target-select">
                <label>Add to</label>
                <select id="aoeTarget">
                    <option value="top">Top Ability</option>
                    <option value="bottom">Bottom Ability</option>
                </select>
            </div>
            <div class="aoe-grid" id="aoeGrid"></div>
            <p class="aoe-hint">Click to add. Drag to move. Use  handle to rotate.</p>
        </div>
    </div>

    <div class="collection-section">
        <h2>Card Collection  <span id="count">0</span> cards</h2>
        <div class="card-grid" id="collection">
            <div class="empty-state">Create cards above and add them to your collection</div>
        </div>
        <div class="collection-buttons">
            <button class="btn btn-gold" onclick="exportPDF()">Export to PDF</button>
            <button class="btn btn-dark" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <script>
        const ICONS = [
            'attack','move','shield','heal','range','target','jump','flying','teleport',
            'push','pull','pierce','retaliate','add_target','taunt','dmg',
            'fire','ice','wind','earth','light','dark','any_element',
            'consume_fire','consume_ice','consume_light','consume_dark','consume_earth','consume_wind','consume_any_element',
            'poison','wound','stun','immobilize','disarm','muddle','curse','bless','strengthen','invisible','ward',
            'recover_card','advantage','disadvantage',
            'lost','spent','round_bonus','persistent_bonus',
            'head','body','one_hand','two_hands','feet','small'
        ];
        const PATH = 'assets/assets/';
        let cards = [];
        let activeField = null;

        // Icons that use PNG instead of SVG
        const PNG_ICONS = [
            'attack', 'push', 'pull', 'move', 'shield', 'heal', 'range', 'target', 'jump', 'flying', 'retaliate', 'teleport',
            'advantage', 'disadvantage',
            'lost', 'spent', 'round_bonus', 'persistent_bonus', 'ward',
            'head', 'body', 'one_hand', 'two_hands', 'feet', 'small'
        ];
        function getIconPath(name) {
            const ext = PNG_ICONS.includes(name) ? 'png' : 'svg';
            return `${PATH}${name}.${ext}`;
        }

        // Icons that need to be inverted (black icons that should appear white)
        const INVERT_ICONS = [
            'dmg', 'taunt',
            'move', 'shield', 'heal', 'range', 'target', 'jump', 'flying', 'retaliate', 'teleport',
            'head', 'body', 'one_hand', 'two_hands', 'feet', 'small'
        ];

        // Build icon grid
        document.getElementById('iconGrid').innerHTML = ICONS.map(i => {
            const style = INVERT_ICONS.includes(i) ? 'style="filter:invert(1)"' : '';
            return `<button class="icon-btn" title="${i.replace(/_/g,' ')}" onclick="insertIcon('${i}')">
                <img src="${getIconPath(i)}" alt="${i}" ${style} onerror="this.parentElement.style.display='none'">
            </button>`;
        }).join('');

        // AOE Patterns
        const AOE_PATTERNS = [
            { name: 'triangle', file: 'triangle.svg', label: 'Triangle' },
            { name: 'adjacent_two_hexes', file: 'adjacent_two_hexes.svg', label: '2 Adjacent' },
            { name: 'adjacent_three_hexes', file: 'adjacent_three_hexes.svg', label: '3 Adjacent' },
            { name: 'adjacent_triangle', file: 'adjacent_triangle.svg', label: 'Adj Triangle' },
            { name: 'skewer', file: 'skewer.svg', label: 'Skewer' },
            { name: 'long_skewer', file: 'long_skewer.svg', label: 'Long Skewer' },
            { name: 'full_hexagon', file: 'full_hexagon.svg', label: 'Full Hex' },
            { name: 'big_smash', file: 'big_smash.svg', label: 'Big Smash' },
            { name: 'single_target', file: 'single_target.svg', label: 'Single Red' },
            { name: 'single_attacker', file: 'single_attacker.svg', label: 'Single Grey' }
        ];
        const AOE_PATH = 'assets/assets/aoe_svg/';

        // Current AOE patterns on the preview card
        let currentAoePatterns = { top: [], bottom: [] };
        let aoeIdCounter = 0;

        // Build AOE grid
        document.getElementById('aoeGrid').innerHTML = AOE_PATTERNS.map(aoe => {
            return `<button class="aoe-btn" title="${aoe.label}" onclick="addAoeToCard('${aoe.name}')">
                <img src="${AOE_PATH}${aoe.file}" alt="${aoe.label}">
            </button>`;
        }).join('');

        // Add AOE pattern to card
        function addAoeToCard(patternName) {
            const target = document.getElementById('aoeTarget').value;
            const pattern = AOE_PATTERNS.find(p => p.name === patternName);
            if (!pattern) return;

            const aoeId = 'aoe_' + (++aoeIdCounter);
            const section = target === 'top' ? 'pTopAoeContainer' : 'pBottomAoeContainer';
            const container = document.getElementById(section);

            // Default position (right side of the ability section)
            const defaultX = 200;
            const defaultY = 20;

            const aoeData = {
                id: aoeId,
                pattern: patternName,
                x: defaultX,
                y: defaultY,
                rotation: 0
            };
            currentAoePatterns[target].push(aoeData);

            renderAoeOnCard(container, aoeData, pattern, target);
        }

        // Scale factor so each hex displays at consistent size (~30px wide, single hex SVG is ~43px)
        const AOE_SCALE = 0.7;

        // Render AOE element on card
        function renderAoeOnCard(container, aoeData, pattern, target) {
            const el = document.createElement('div');
            el.className = 'aoe-draggable';
            el.id = aoeData.id;
            el.style.left = aoeData.x + 'px';
            el.style.top = aoeData.y + 'px';
            el.innerHTML = `
                <img src="${AOE_PATH}${pattern.file}" alt="${pattern.label}" style="transform: scale(${AOE_SCALE}) rotate(${aoeData.rotation}deg);">
                <button class="aoe-remove" onclick="removeAoe('${aoeData.id}', '${target}')">&times;</button>
                <div class="aoe-rotate" title="Drag to rotate"></div>
            `;
            container.appendChild(el);
            makeDraggable(el, aoeData, target);
            makeRotatable(el, aoeData);
        }

        // Make AOE rotatable via drag handle
        function makeRotatable(el, aoeData) {
            const rotateHandle = el.querySelector('.aoe-rotate');
            const img = el.querySelector('img');
            let isRotating = false;
            let centerX, centerY;

            rotateHandle.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                isRotating = true;
                const rect = el.getBoundingClientRect();
                centerX = rect.left + rect.width / 2;
                centerY = rect.top + rect.height / 2;
                rotateHandle.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', function(e) {
                if (!isRotating) return;
                const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                const degrees = angle * (180 / Math.PI) + 90; // +90 to make top = 0
                aoeData.rotation = degrees;
                img.style.transform = 'scale(' + AOE_SCALE + ') rotate(' + degrees + 'deg)';
            });

            document.addEventListener('mouseup', function() {
                if (isRotating) {
                    isRotating = false;
                    rotateHandle.style.cursor = 'grab';
                }
            });
        }

        // Remove AOE from card
        function removeAoe(aoeId, target) {
            const el = document.getElementById(aoeId);
            if (el) el.remove();
            currentAoePatterns[target] = currentAoePatterns[target].filter(a => a.id !== aoeId);
        }

        // Make AOE draggable
        function makeDraggable(el, aoeData, target) {
            let offsetX, offsetY, isDragging = false;

            el.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('aoe-remove')) return;
                isDragging = true;
                offsetX = e.clientX - el.offsetLeft;
                offsetY = e.clientY - el.offsetTop;
                el.style.zIndex = 10;
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                const x = e.clientX - offsetX;
                const y = e.clientY - offsetY;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                aoeData.x = x;
                aoeData.y = y;
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    el.style.zIndex = 5;
                }
            });
        }

        // Clear AOE patterns from preview
        function clearAoePatterns() {
            ['pTopAoeContainer', 'pBottomAoeContainer'].forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });
            currentAoePatterns = { top: [], bottom: [] };
        }

        // Track active text field
        ['top','bottom','flavor'].forEach(id => {
            document.getElementById(id).addEventListener('focus', e => activeField = e.target);
        });

        function insertIcon(name) {
            if (!activeField) activeField = document.getElementById('top');
            const tag = `[${name}]`;
            const s = activeField.selectionStart, e = activeField.selectionEnd;
            activeField.value = activeField.value.substring(0,s) + tag + activeField.value.substring(e);
            activeField.focus();
            activeField.selectionStart = activeField.selectionEnd = s + tag.length;
            update();
        }

        // Text formatting functions
        function formatText(fieldId, tag) {
            const field = document.getElementById(fieldId);
            const start = field.selectionStart;
            const end = field.selectionEnd;
            const text = field.value;
            const selected = text.substring(start, end);

            if (selected) {
                const wrapped = `[${tag}]${selected}[/${tag}]`;
                field.value = text.substring(0, start) + wrapped + text.substring(end);
                field.focus();
                field.selectionStart = start;
                field.selectionEnd = start + wrapped.length;
            } else {
                // Insert empty tags and place cursor between them
                const tags = `[${tag}][/${tag}]`;
                field.value = text.substring(0, start) + tags + text.substring(end);
                field.focus();
                field.selectionStart = field.selectionEnd = start + tag.length + 2;
            }
            update();
        }

        function formatSize(fieldId, size) {
            if (!size) return;
            const field = document.getElementById(fieldId);
            const start = field.selectionStart;
            const end = field.selectionEnd;
            const text = field.value;
            const selected = text.substring(start, end);

            if (selected) {
                const wrapped = `[s:${size}]${selected}[/s]`;
                field.value = text.substring(0, start) + wrapped + text.substring(end);
                field.focus();
                field.selectionStart = start;
                field.selectionEnd = start + wrapped.length;
            } else {
                const tags = `[s:${size}][/s]`;
                field.value = text.substring(0, start) + tags + text.substring(end);
                field.focus();
                field.selectionStart = field.selectionEnd = start + size.toString().length + 4;
            }
            update();
        }

        // Parse formatting only (for flavor text - no icons)
        function parseFormatting(text, fontScale = 1) {
            if (!text) return '';
            return text
                .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>')
                .replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>')
                .replace(/\[s:(\d+)\](.*?)\[\/s\]/g, (m, size, content) => {
                    const scaledSize = Math.round(parseInt(size) * fontScale);
                    return `<span style="font-size:${scaledSize}px">${content}</span>`;
                })
                .replace(/\n/g, '<br>');
        }

        // Class icon mapping
        const CLASS_ICONS = {
            'bruiser': '01_bruiser.png',
            'tinkerer': '02_tinkerer.png',
            'spellweaver': '03_spellweaver.png',
            'silent_knife': '04_silent_knife.png',
            'cragheart': '05_cragheart.png',
            'mindthief': '06_mindthief.png',
            'sun': '07_sun.png',
            'three_spears': '08_three_spears.png',
            'cthulhu': '11_cthulhu.png',
            'lightning_bolts': '12_lightning_bolts.png',
            'music_note': '13_music_note.png',
            'angry_face': '14_angry_face.png',
            'saw': '15_saw.png',
            'triangles': '16_triangles.png',
            'two_minis': '17_two_minis.png',
            'crossed_swords': '18_crossed_swords.png'
        };

        // Color presets for each class (extracted from official card images)
        const CLASS_COLORS = {
            'custom': { header: '#808080', topAction: '#4a5a6a', bottomAction: '#1a2a3a', hexInner: '#2a3a4a', hexRim: '#5a6a7a', frame: '#4a4a4a' },
            'bruiser': { header: '#7a8a9a', topAction: '#4a6a8a', bottomAction: '#1a3a5a', hexInner: '#1a3a5a', hexRim: '#4a6a8a', frame: '#5a5a5a' },
            'tinkerer': { header: '#b0a090', topAction: '#a89878', bottomAction: '#302818', hexInner: '#302818', hexRim: '#6a5a48', frame: '#5a5a5a' },
            'spellweaver': { header: '#9a7aaa', topAction: '#7a5a8a', bottomAction: '#2a1a3a', hexInner: '#2a1a3a', hexRim: '#6a5a7a', frame: '#3a3a3a' },
            'silent_knife': { header: '#8aba6a', topAction: '#5a8a4a', bottomAction: '#1a3018', hexInner: '#1a3018', hexRim: '#4a6a3a', frame: '#4a4a4a' },
            'cragheart': { header: '#a0a060', topAction: '#7a8a40', bottomAction: '#3a4020', hexInner: '#3a4020', hexRim: '#6a7a40', frame: '#5a5a5a' },
            'mindthief': { header: '#7a8a9a', topAction: '#5a6a7a', bottomAction: '#2a3a4a', hexInner: '#2a3a4a', hexRim: '#5a6a7a', frame: '#4a4a4a' },
            'sun': { header: '#c0a050', topAction: '#9a6050', bottomAction: '#4a2020', hexInner: '#4a2020', hexRim: '#7a5040', frame: '#a08050' },
            'three_spears': { header: '#b09070', topAction: '#9a7a60', bottomAction: '#4a3020', hexInner: '#4a3020', hexRim: '#7a6050', frame: '#7a6a5a' },
            'cthulhu': { header: '#60a0a0', topAction: '#4a8a8a', bottomAction: '#1a4a4a', hexInner: '#1a4a4a', hexRim: '#4a7a7a', frame: '#4a4a4a' },
            'lightning_bolts': { header: '#a06060', topAction: '#7a4040', bottomAction: '#3a1818', hexInner: '#3a1818', hexRim: '#6a4040', frame: '#4a4a4a' },
            'music_note': { header: '#c09080', topAction: '#7a4a60', bottomAction: '#3a1a30', hexInner: '#3a1a30', hexRim: '#6a4a58', frame: '#5a5a5a' },
            'angry_face': { header: '#70b0b0', topAction: '#50a0a0', bottomAction: '#205050', hexInner: '#205050', hexRim: '#408080', frame: '#4a4a4a' },
            'saw': { header: '#a08080', topAction: '#8a6050', bottomAction: '#3a2820', hexInner: '#3a2820', hexRim: '#6a5048', frame: '#5a5a5a' },
            'triangles': { header: '#809090', topAction: '#5a7070', bottomAction: '#2a3a3a', hexInner: '#2a3a3a', hexRim: '#4a6060', frame: '#4a4a4a' },
            'two_minis': { header: '#90706a', topAction: '#5a7070', bottomAction: '#2a4040', hexInner: '#2a4040', hexRim: '#4a6060', frame: '#5a5a5a' },
            'crossed_swords': { header: '#b09060', topAction: '#9a7050', bottomAction: '#4a3020', hexInner: '#4a3020', hexRim: '#7a6048', frame: '#6a5a4a' }
        };

        // Function to blend two colors (for flavor text - between top and bottom)
        function blendColors(color1, color2, ratio = 0.5) {
            const c1 = parseInt(color1.slice(1), 16);
            const c2 = parseInt(color2.slice(1), 16);
            const r1 = (c1 >> 16) & 0xFF, g1 = (c1 >> 8) & 0xFF, b1 = c1 & 0xFF;
            const r2 = (c2 >> 16) & 0xFF, g2 = (c2 >> 8) & 0xFF, b2 = c2 & 0xFF;
            const r = Math.round(r1 * (1 - ratio) + r2 * ratio);
            const g = Math.round(g1 * (1 - ratio) + g2 * ratio);
            const b = Math.round(b1 * (1 - ratio) + b2 * ratio);
            return `#${(0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1)}`;
        }

        // Apply class color preset to form inputs
        function applyClassColors(className) {
            const colors = CLASS_COLORS[className] || CLASS_COLORS['custom'];
            document.getElementById('colorHeader').value = colors.header;
            document.getElementById('colorTopAction').value = colors.topAction;
            document.getElementById('colorBottomAction').value = colors.bottomAction;
            document.getElementById('colorHexInner').value = colors.hexInner;
            document.getElementById('colorHexRim').value = colors.hexRim;
            document.getElementById('colorFrame').value = colors.frame;
            // Flavor text: blend between top and bottom (30% toward bottom)
            document.getElementById('colorFlavor').value = blendColors(colors.topAction, colors.bottomAction, 0.3);
            update();
        }

        // Scale adjustments for icons that are too large in source (PNG icons)
        const ICON_SCALE = {
            'attack': 0.7, 'move': 0.7, 'shield': 0.7, 'heal': 0.7, 'range': 0.7, 'target': 0.7,
            'jump': 0.7, 'flying': 0.7, 'retaliate': 0.7, 'teleport': 0.7,
            'push': 1.05, 'pull': 1.05, 'ward': 1.05,
            'advantage': 1.05, 'disadvantage': 1.05, 'recover_card': 1.15,
            'lost': 0.7, 'spent': 0.7, 'round_bonus': 0.7, 'persistent_bonus': 0.7,
            'head': 0.7, 'body': 0.7, 'one_hand': 0.7, 'two_hands': 0.7, 'feet': 0.7, 'small': 0.7
        };

        function parse(text, scale = 1, fontScale = 1) {
            if (!text) return '<span></span>';
            const baseIconSize = 1.8 * scale;
            let parsed = text
                // Icons
                .replace(/\[(\w+)\]/g, (m, n) => {
                    if (!ICONS.includes(n)) return m;
                    const iconScale = ICON_SCALE[n] || 1;
                    const iconSize = baseIconSize * iconScale;
                    let style = `height: ${iconSize}em; width: auto; vertical-align: middle; margin: 0 2px;`;
                    if (INVERT_ICONS.includes(n)) style += ' filter: invert(1);';
                    return `<img style="${style}" src="${getIconPath(n)}" alt="${n}">`;
                })
                // Bold
                .replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>')
                // Italic
                .replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>')
                // Font size
                .replace(/\[s:(\d+)\](.*?)\[\/s\]/g, (m, size, content) => {
                    const scaledSize = Math.round(parseInt(size) * fontScale);
                    return `<span style="font-size:${scaledSize}px">${content}</span>`;
                })
                // Line breaks
                .replace(/\n/g, '<br>');
            return `<span>${parsed}</span>`;
        }

        // Calculate icon right position for inline styles (used in collection and PDF)
        function getIconRightPosition(isLoss, lossVisible, bonusVisible, baseRight, iconWidth) {
            if (isLoss && lossVisible && bonusVisible) {
                return baseRight + iconWidth + 4;
            }
            return baseRight;
        }

        // Position icons dynamically in bottom-right corner
        // Loss icon goes on the left when bonus icon is also visible
        // Bonus icon (round-bonus or persistent) goes on the right
        function positionIcons(lossId, roundBonusId, persistentId, baseRight, iconWidth) {
            const lossEl = document.getElementById(lossId);
            const roundBonusEl = document.getElementById(roundBonusId);
            const persistentEl = document.getElementById(persistentId);

            const lossVisible = lossEl.classList.contains('visible');
            const roundBonusVisible = roundBonusEl.classList.contains('visible');
            const persistentVisible = persistentEl.classList.contains('visible');
            const bonusVisible = roundBonusVisible || persistentVisible;

            // Bonus icon always at right edge when visible
            roundBonusEl.style.right = baseRight + 'px';
            persistentEl.style.right = baseRight + 'px';

            // Loss icon: at right edge if alone, or offset left if bonus is also visible
            if (lossVisible && bonusVisible) {
                lossEl.style.right = (baseRight + iconWidth + 4) + 'px';
            } else {
                lossEl.style.right = baseRight + 'px';
            }
        }

        function toggleBonus(section, type) {
            const roundBonusId = section + 'RoundBonus';
            const persistentId = section + 'Persistent';
            const roundBonusEl = document.getElementById(roundBonusId);
            const persistentEl = document.getElementById(persistentId);

            if (type === 'RoundBonus' && roundBonusEl.checked) {
                persistentEl.checked = false;
            } else if (type === 'Persistent' && persistentEl.checked) {
                roundBonusEl.checked = false;
            }
            update();
        }

        // Summon image data storage
        const summonImages = { top: null, bottom: null };

        function toggleSummon(section) {
            const configEl = document.getElementById(section + 'SummonConfig');
            const checked = document.getElementById(section + 'Summon').checked;
            configEl.classList.toggle('visible', checked);
            update();
        }

        function handleSummonImage(section) {
            const input = document.getElementById(section + 'SummonImage');
            const preview = document.getElementById(section + 'SummonImagePreview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    summonImages[section] = e.target.result;
                    preview.innerHTML = `<img src="${e.target.result}" alt="Summon portrait">`;
                    update();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateSummonPreview(section) {
            const isEnabled = document.getElementById(section + 'Summon').checked;
            const summonBox = document.getElementById('p' + capitalize(section) + 'SummonBox');
            const summonHeader = document.getElementById('p' + capitalize(section) + 'SummonHeader');
            const summonExtra = document.getElementById('p' + capitalize(section) + 'SummonExtra');
            const abilityText = document.getElementById('p' + capitalize(section));

            if (isEnabled) {
                const name = document.getElementById(section + 'SummonName').value || 'Summon';
                const hp = document.getElementById(section + 'SummonHP').value || '-';
                const move = document.getElementById(section + 'SummonMove').value || '-';
                const attack = document.getElementById(section + 'SummonAttack').value || '-';
                const range = document.getElementById(section + 'SummonRange').value || '-';
                const special = document.getElementById(section + 'SummonSpecial').value || '';
                const extra = document.getElementById(section + 'SummonExtra').value || '';

                summonHeader.textContent = 'Summon ' + name;
                summonBox.classList.add('visible');

                // Update stats
                document.getElementById('p' + capitalize(section) + 'SummonHP').textContent = hp;
                document.getElementById('p' + capitalize(section) + 'SummonMove').textContent = move;
                document.getElementById('p' + capitalize(section) + 'SummonAttack').textContent = attack;
                document.getElementById('p' + capitalize(section) + 'SummonRange').textContent = range;

                // Update portrait
                const portrait = document.getElementById('p' + capitalize(section) + 'SummonPortrait');
                if (summonImages[section]) {
                    portrait.innerHTML = `<img src="${summonImages[section]}" alt="Summon">`;
                } else {
                    portrait.innerHTML = '';
                }

                // Update special text
                const specialEl = document.getElementById('p' + capitalize(section) + 'SummonSpecial');
                specialEl.textContent = special;

                // Update extra text (with icon parsing)
                if (extra.trim()) {
                    summonExtra.innerHTML = parse(extra, 0.75);
                    summonExtra.style.display = 'block';
                } else {
                    summonExtra.innerHTML = '';
                    summonExtra.style.display = 'none';
                }

                // Hide the regular ability text when summon is active
                abilityText.style.display = 'none';
            } else {
                summonHeader.textContent = '';
                summonBox.classList.remove('visible');
                summonExtra.innerHTML = '';
                summonExtra.style.display = 'none';
                abilityText.style.display = '';
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function update() {
            document.getElementById('pName').textContent = document.getElementById('name').value || 'Card Name';
            document.getElementById('pLevel').textContent = document.getElementById('level').value;
            document.getElementById('pInit').textContent = document.getElementById('initiative').value || '20';
            const flavorText = document.getElementById('flavor').value || '';
            const flavorEl = document.getElementById('pFlavor');
            flavorEl.innerHTML = parseFormatting(flavorText);
            // Hide flavor text and its divider if empty
            if (!flavorText.trim()) {
                flavorEl.classList.add('hidden');
            } else {
                flavorEl.classList.remove('hidden');
            }
            document.getElementById('pLeft').textContent = document.getElementById('leftVal').value || '';
            document.getElementById('pRight').textContent = document.getElementById('rightVal').value || '';
            document.getElementById('pTop').innerHTML = parse(document.getElementById('top').value);
            document.getElementById('pBottom').innerHTML = parse(document.getElementById('bottom').value);

            // Toggle loss/round_bonus/persistent indicators
            document.getElementById('pTopLoss').classList.toggle('visible', document.getElementById('topLoss').checked);
            document.getElementById('pTopRoundBonus').classList.toggle('visible', document.getElementById('topRoundBonus').checked);
            document.getElementById('pTopPersistent').classList.toggle('visible', document.getElementById('topPersistent').checked);
            document.getElementById('pBottomLoss').classList.toggle('visible', document.getElementById('bottomLoss').checked);
            document.getElementById('pBottomRoundBonus').classList.toggle('visible', document.getElementById('bottomRoundBonus').checked);
            document.getElementById('pBottomPersistent').classList.toggle('visible', document.getElementById('bottomPersistent').checked);

            // Position icons dynamically in bottom-right corner
            positionIcons('pTopLoss', 'pTopRoundBonus', 'pTopPersistent', 20, 35);
            positionIcons('pBottomLoss', 'pBottomRoundBonus', 'pBottomPersistent', 20, 35);

            const preview = document.getElementById('preview');
            const selectedClass = document.getElementById('classSelect').value;
            preview.className = 'card ' + selectedClass;

            // Set class icon
            const classIcon = document.getElementById('pClassIcon');
            if (CLASS_ICONS[selectedClass]) {
                classIcon.innerHTML = `<img src="assets/assets/classes/${CLASS_ICONS[selectedClass]}" alt="${selectedClass}">`;
            } else {
                classIcon.innerHTML = '';
            }

            // Apply custom colors
            const headerColor = document.getElementById('colorHeader').value;
            const flavorColor = document.getElementById('colorFlavor').value;
            const topActionColor = document.getElementById('colorTopAction').value;
            const bottomActionColor = document.getElementById('colorBottomAction').value;
            const hexInnerColor = document.getElementById('colorHexInner').value;
            const hexRimColor = document.getElementById('colorHexRim').value;
            const frameColor = document.getElementById('colorFrame').value;

            // Apply frame color (gradient: lighter edges, darker middle for 3D metallic look)
            const frameGradient = `linear-gradient(180deg, ${lightenColor(frameColor, 6)} 0%, ${darkenColor(frameColor, 5)} 15%, ${darkenColor(frameColor, 10)} 50%, ${darkenColor(frameColor, 5)} 85%, ${darkenColor(frameColor, 2)} 100%)`;
            preview.style.setProperty('--frame-gradient', frameGradient);

            // Apply colors to card sections
            const cardBg = document.getElementById('pCardBg');
            cardBg.style.background = bottomActionColor;

            // Apply to ability sections and initiative
            const topSection = document.querySelector('#preview .ability-section.top');
            const bottomSection = document.querySelector('#preview .ability-section.bottom');
            const initSection = document.querySelector('#preview .initiative-section');

            topSection.style.background = `
                radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 50%, rgba(255,255,255,0.06) 0%, transparent 40%),
                ${topActionColor}
            `;
            bottomSection.style.background = `
                radial-gradient(ellipse at 50% 70%, rgba(0,0,0,0.15) 0%, transparent 50%),
                ${bottomActionColor}
            `;
            initSection.style.background = `linear-gradient(180deg, ${topActionColor} 0%, ${topActionColor} 50%, ${bottomActionColor} 50%, ${bottomActionColor} 100%)`;
            flavorEl.style.background = flavorColor;

            const header = document.querySelector('#preview .card-header');
            header.style.background = `linear-gradient(180deg, ${lightenColor(headerColor, 30)} 0%, ${headerColor} 20%, ${darkenColor(headerColor, 20)} 80%, ${darkenColor(headerColor, 40)} 100%)`;

            // Apply header color to side bars
            const sideBarGradient = `linear-gradient(180deg, ${lightenColor(headerColor, 20)} 0%, ${darkenColor(headerColor, 20)} 100%)`;
            document.querySelector('#preview .card-side-left').style.background = sideBarGradient;
            document.querySelector('#preview .card-side-right').style.background = sideBarGradient;

            // Apply header color to divider lines via CSS variable
            const darkerHeader = darkenColor(headerColor, 20);
            preview.style.setProperty('--class-header-dark', darkerHeader);
            topSection.style.borderTopColor = darkerHeader;

            // Apply hex colors using CSS variables (for inner fill and rim)
            const hexInnerGradient = `linear-gradient(180deg, ${lightenColor(hexInnerColor, 15)} 0%, ${hexInnerColor} 50%, ${darkenColor(hexInnerColor, 15)} 100%)`;
            const hexRimGradient = `linear-gradient(180deg, ${lightenColor(hexRimColor, 20)} 0%, ${hexRimColor} 50%, ${darkenColor(hexRimColor, 20)} 100%)`;
            preview.style.setProperty('--hex-inner', hexInnerGradient);
            preview.style.setProperty('--hex-rim', hexRimGradient);

            // Update summon previews
            updateSummonPreview('top');
            updateSummonPreview('bottom');
        }

        // Helper functions to lighten/darken colors
        function lightenColor(hex, percent) {
            const num = parseInt(hex.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
        }

        function darkenColor(hex, percent) {
            const num = parseInt(hex.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, ((num >> 8) & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
        }

        ['name','classSelect','level','initiative','top','bottom','flavor','leftVal','rightVal','colorHeader','colorFlavor','colorTopAction','colorBottomAction','colorHexInner','colorHexRim','colorFrame',
         'topSummonName','topSummonHP','topSummonMove','topSummonAttack','topSummonRange','topSummonSpecial','topSummonExtra',
         'bottomSummonName','bottomSummonHP','bottomSummonMove','bottomSummonAttack','bottomSummonRange','bottomSummonSpecial','bottomSummonExtra'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', update);
            el.addEventListener('change', update);
        });

        // Apply class colors when class selection changes
        document.getElementById('classSelect').addEventListener('change', function() {
            applyClassColors(this.value);
        });

        function addCard() {
            cards.push({
                name: document.getElementById('name').value || 'Unnamed',
                cls: document.getElementById('classSelect').value,
                level: document.getElementById('level').value,
                initiative: document.getElementById('initiative').value || '20',
                flavor: document.getElementById('flavor').value || '',
                leftVal: document.getElementById('leftVal').value || '',
                rightVal: document.getElementById('rightVal').value || '',
                top: document.getElementById('top').value,
                bottom: document.getElementById('bottom').value,
                topLoss: document.getElementById('topLoss').checked,
                topRoundBonus: document.getElementById('topRoundBonus').checked,
                topPersistent: document.getElementById('topPersistent').checked,
                bottomLoss: document.getElementById('bottomLoss').checked,
                bottomRoundBonus: document.getElementById('bottomRoundBonus').checked,
                bottomPersistent: document.getElementById('bottomPersistent').checked,
                colorHeader: document.getElementById('colorHeader').value,
                colorFlavor: document.getElementById('colorFlavor').value,
                colorTopAction: document.getElementById('colorTopAction').value,
                colorBottomAction: document.getElementById('colorBottomAction').value,
                colorHexInner: document.getElementById('colorHexInner').value,
                colorHexRim: document.getElementById('colorHexRim').value,
                colorFrame: document.getElementById('colorFrame').value,
                // Save AOE patterns with their positions and rotation
                aoeTop: currentAoePatterns.top.map(a => ({ pattern: a.pattern, x: a.x, y: a.y, rotation: a.rotation || 0 })),
                aoeBottom: currentAoePatterns.bottom.map(a => ({ pattern: a.pattern, x: a.x, y: a.y, rotation: a.rotation || 0 })),
                // Save summon data
                topSummon: document.getElementById('topSummon').checked,
                topSummonName: document.getElementById('topSummonName').value || '',
                topSummonHP: document.getElementById('topSummonHP').value || '',
                topSummonMove: document.getElementById('topSummonMove').value || '',
                topSummonAttack: document.getElementById('topSummonAttack').value || '',
                topSummonRange: document.getElementById('topSummonRange').value || '',
                topSummonSpecial: document.getElementById('topSummonSpecial').value || '',
                topSummonExtra: document.getElementById('topSummonExtra').value || '',
                topSummonImage: summonImages.top || null,
                bottomSummon: document.getElementById('bottomSummon').checked,
                bottomSummonName: document.getElementById('bottomSummonName').value || '',
                bottomSummonHP: document.getElementById('bottomSummonHP').value || '',
                bottomSummonMove: document.getElementById('bottomSummonMove').value || '',
                bottomSummonAttack: document.getElementById('bottomSummonAttack').value || '',
                bottomSummonRange: document.getElementById('bottomSummonRange').value || '',
                bottomSummonSpecial: document.getElementById('bottomSummonSpecial').value || '',
                bottomSummonExtra: document.getElementById('bottomSummonExtra').value || '',
                bottomSummonImage: summonImages.bottom || null
            });
            renderCollection();
        }

        function removeCard(i) {
            cards.splice(i, 1);
            renderCollection();
        }

        // Generate Summon HTML for collection/PDF
        function renderSummonHtml(summonData, fontScale = 1) {
            if (!summonData || !summonData.enabled) return { header: '', box: '', extra: '', hideAbility: false };

            const header = `<div class="summon-header">Summon ${summonData.name || 'Summon'}</div>`;
            const portrait = summonData.image ? `<img src="${summonData.image}" alt="Summon">` : '';
            const box = `
                <div class="summon-box visible">
                    <div class="summon-content">
                        <div class="summon-portrait">${portrait}</div>
                        <div class="summon-stats">
                            <div class="summon-stat"><img src="assets/assets/heal.svg" alt="HP"><span>${summonData.hp || '-'}</span></div>
                            <div class="summon-stat"><img src="assets/assets/move.svg" alt="Move"><span>${summonData.move || '-'}</span></div>
                            <div class="summon-stat"><img src="assets/assets/attack.svg" alt="Attack"><span>${summonData.attack || '-'}</span></div>
                            <div class="summon-stat"><img src="assets/assets/range.svg" alt="Range"><span>${summonData.range || '-'}</span></div>
                        </div>
                        <div class="summon-special">${summonData.special || ''}</div>
                    </div>
                </div>
            `;
            const extra = summonData.extra ? `<div class="summon-extra-text">${parse(summonData.extra, 0.75, fontScale)}</div>` : '';

            return { header, box, extra, hideAbility: true };
        }

        // Generate AOE HTML for collection/PDF (scaled down)
        function renderAoeHtml(aoeList, scale = 1) {
            if (!aoeList || !aoeList.length) return '';
            return aoeList.map(aoe => {
                const pattern = AOE_PATTERNS.find(p => p.name === aoe.pattern);
                if (!pattern) return '';
                const scaledX = Math.round(aoe.x * scale);
                const scaledY = Math.round(aoe.y * scale);
                const aoeScale = AOE_SCALE * scale;
                const rotation = aoe.rotation || 0;
                return `<div class="aoe-static" style="position:absolute;left:${scaledX}px;top:${scaledY}px;">
                    <img src="${AOE_PATH}${pattern.file}" alt="${pattern.label}" style="transform:scale(${aoeScale}) rotate(${rotation}deg);transform-origin:center center;">
                </div>`;
            }).join('');
        }

        function renderCollection() {
            document.getElementById('count').textContent = cards.length;
            const container = document.getElementById('collection');

            if (!cards.length) {
                container.innerHTML = '<div class="empty-state">Create cards above and add them to your collection</div>';
                return;
            }

            // Collection scale factor (190/320 = 0.59)
            const collectionScale = 0.59;

            container.innerHTML = cards.map((c, i) => {
                // Collection view: 12px icons, 12px base right (to avoid frame bulge)
                const topBonusVisible = c.topRoundBonus || c.topPersistent;
                const bottomBonusVisible = c.bottomRoundBonus || c.bottomPersistent;
                const topLossRight = getIconRightPosition(true, c.topLoss, topBonusVisible, 12, 20);
                const bottomLossRight = getIconRightPosition(true, c.bottomLoss, bottomBonusVisible, 12, 20);

                // Generate color styles
                const headerColor = c.colorHeader || '#808080';
                const flavorColor = c.colorFlavor || '#2a3a4a';
                const topActionColor = c.colorTopAction || '#4a5a6a';
                const bottomActionColor = c.colorBottomAction || '#1a2a3a';
                const hexInnerColor = c.colorHexInner || '#2a3a4a';
                const hexRimColor = c.colorHexRim || '#5a6a7a';
                const frameColor = c.colorFrame || '#4a4a4a';

                const darkerHeader = darkenColor(headerColor, 20);
                const bgStyle = `background: ${bottomActionColor}`;
                const topSectionStyle = `background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.12) 0%, transparent 50%), radial-gradient(ellipse at 70% 50%, rgba(255,255,255,0.06) 0%, transparent 40%), ${topActionColor}; border-top-color: ${darkerHeader}`;
                const bottomSectionStyle = `background: radial-gradient(ellipse at 50% 70%, rgba(0,0,0,0.15) 0%, transparent 50%), ${bottomActionColor}; margin-top: -1px`;
                const initSectionStyle = `background: linear-gradient(180deg, ${topActionColor} 0%, ${topActionColor} 50%, ${bottomActionColor} 50%, ${bottomActionColor} 100%); --class-header-dark: transparent; margin-top: -1px`;
                const flavorStyle = `background: ${flavorColor}`;
                const headerStyle = `background: linear-gradient(180deg, ${lightenColor(headerColor, 30)} 0%, ${headerColor} 20%, ${darkenColor(headerColor, 20)} 80%, ${darkenColor(headerColor, 40)} 100%)`;
                const sideBarStyle = `background: linear-gradient(180deg, ${lightenColor(headerColor, 20)} 0%, ${darkenColor(headerColor, 20)} 100%)`;
                const hexInnerGradient = `linear-gradient(180deg, ${lightenColor(hexInnerColor, 15)} 0%, ${hexInnerColor} 50%, ${darkenColor(hexInnerColor, 15)} 100%)`;
                const hexRimGradient = `linear-gradient(180deg, ${lightenColor(hexRimColor, 20)} 0%, ${hexRimColor} 50%, ${darkenColor(hexRimColor, 20)} 100%)`;
                const frameGradient = `linear-gradient(180deg, ${lightenColor(frameColor, 6)} 0%, ${darkenColor(frameColor, 5)} 15%, ${darkenColor(frameColor, 10)} 50%, ${darkenColor(frameColor, 5)} 85%, ${darkenColor(frameColor, 2)} 100%)`;
                const hexVars = `--hex-inner: ${hexInnerGradient}; --hex-rim: ${hexRimGradient}; --class-header-dark: ${darkerHeader}; --frame-gradient: ${frameGradient}`;

                // Render AOE patterns for collection (scaled)
                const topAoeHtml = renderAoeHtml(c.aoeTop || [], collectionScale);
                const bottomAoeHtml = renderAoeHtml(c.aoeBottom || [], collectionScale);

                // Render summon data for collection
                const topSummonData = {
                    enabled: c.topSummon,
                    name: c.topSummonName,
                    hp: c.topSummonHP,
                    move: c.topSummonMove,
                    attack: c.topSummonAttack,
                    range: c.topSummonRange,
                    special: c.topSummonSpecial,
                    extra: c.topSummonExtra,
                    image: c.topSummonImage
                };
                const bottomSummonData = {
                    enabled: c.bottomSummon,
                    name: c.bottomSummonName,
                    hp: c.bottomSummonHP,
                    move: c.bottomSummonMove,
                    attack: c.bottomSummonAttack,
                    range: c.bottomSummonRange,
                    special: c.bottomSummonSpecial,
                    extra: c.bottomSummonExtra,
                    image: c.bottomSummonImage
                };
                const topSummon = renderSummonHtml(topSummonData, 0.6);
                const bottomSummon = renderSummonHtml(bottomSummonData, 0.6);

                return `
                <div class="card-wrapper">
                    <button class="remove-btn" onclick="removeCard(${i})"></button>
                    <div class="card ${c.cls}" style="${hexVars}">
                        <div class="card-bg" style="${bgStyle}"></div>
                        <div class="card-texture"></div>
                        <div class="card-overlay"></div>
                        <div class="card-frame"></div>
                        <div class="card-frame-bulge-left"></div>
                        <div class="card-frame-bulge-right"></div>
                        <div class="card-side-left" style="${sideBarStyle}"></div>
                        <div class="card-side-right" style="${sideBarStyle}"></div>
                        <div class="card-content">
                            <div class="card-header" style="${headerStyle}">
                                <div class="header-row">
                                    <div class="level-hex"><span>${c.level}</span></div>
                                    <div class="name-banner">
                                        <div class="card-name">${c.name}</div>
                                    </div>
                                    <div class="class-icon">${CLASS_ICONS[c.cls] ? `<img src="assets/assets/classes/${CLASS_ICONS[c.cls]}" alt="${c.cls}">` : ''}</div>
                                </div>
                            </div>
                            <div class="flavor-text${!c.flavor || !c.flavor.trim() ? ' hidden' : ''}" style="${flavorStyle}">${parseFormatting(c.flavor || '', 0.67)}</div>
                            <div class="ability-section top" style="${topSectionStyle}">
                                ${topSummon.header}
                                ${topSummon.box}
                                ${topSummon.extra}
                                <div class="ability-text" ${topSummon.hideAbility ? 'style="display:none"' : ''}>${parse(c.top, 1, 0.6)}</div>
                                <div class="aoe-container">${topAoeHtml}</div>
                                <img class="ability-indicator loss ${c.topLoss ? 'visible' : ''}" style="right:${topLossRight}px" src="assets/assets/lost.png" alt="loss">
                                <img class="ability-indicator round-bonus ${c.topRoundBonus ? 'visible' : ''}" style="right:12px" src="assets/assets/round_bonus.png" alt="round bonus">
                                <img class="ability-indicator persistent ${c.topPersistent ? 'visible' : ''}" style="right:12px" src="assets/assets/persistent_bonus.png" alt="persistent">
                            </div>
                            <div class="initiative-section" style="${initSectionStyle}">
                                <div class="side-value"><span>${c.leftVal || ''}</span></div>
                                <div class="initiative-main">
                                    <span class="initiative-value">${c.initiative}</span>
                                </div>
                                <div class="side-value"><span>${c.rightVal || ''}</span></div>
                            </div>
                            <div class="ability-section bottom" style="${bottomSectionStyle}">
                                ${bottomSummon.header}
                                ${bottomSummon.box}
                                ${bottomSummon.extra}
                                <div class="ability-text" ${bottomSummon.hideAbility ? 'style="display:none"' : ''}>${parse(c.bottom, 1, 0.6)}</div>
                                <div class="aoe-container">${bottomAoeHtml}</div>
                                <img class="ability-indicator loss ${c.bottomLoss ? 'visible' : ''}" style="right:${bottomLossRight}px" src="assets/assets/lost.png" alt="loss">
                                <img class="ability-indicator round-bonus ${c.bottomRoundBonus ? 'visible' : ''}" style="right:12px" src="assets/assets/round_bonus.png" alt="round bonus">
                                <img class="ability-indicator persistent ${c.bottomPersistent ? 'visible' : ''}" style="right:12px" src="assets/assets/persistent_bonus.png" alt="persistent">
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function clearForm() {
            ['name','top','bottom','flavor','leftVal','rightVal'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('level').value = '1';
            document.getElementById('initiative').value = '20';
            document.getElementById('classSelect').value = 'custom';
            document.getElementById('topLoss').checked = false;
            document.getElementById('topRoundBonus').checked = false;
            document.getElementById('topPersistent').checked = false;
            document.getElementById('bottomLoss').checked = false;
            document.getElementById('bottomRoundBonus').checked = false;
            document.getElementById('bottomPersistent').checked = false;
            // Apply custom class colors (reset to default)
            applyClassColors('custom');
            clearAoePatterns();
            // Clear summon fields
            ['top', 'bottom'].forEach(section => {
                document.getElementById(section + 'Summon').checked = false;
                document.getElementById(section + 'SummonConfig').classList.remove('visible');
                document.getElementById(section + 'SummonName').value = '';
                document.getElementById(section + 'SummonHP').value = '';
                document.getElementById(section + 'SummonMove').value = '';
                document.getElementById(section + 'SummonAttack').value = '';
                document.getElementById(section + 'SummonRange').value = '';
                document.getElementById(section + 'SummonSpecial').value = '';
                document.getElementById(section + 'SummonExtra').value = '';
                document.getElementById(section + 'SummonImagePreview').innerHTML = '';
            });
            summonImages.top = null;
            summonImages.bottom = null;
            update();
        }

        function clearAll() {
            if (confirm('Clear all cards from collection?')) {
                cards = [];
                renderCollection();
            }
        }

        // Print-based export - opens new window with cards for printing/saving as PDF
        function exportPrint() {
            if (!cards.length) { alert('Add cards to collection first'); return; }

            const printWindow = window.open('', '_blank');

            // Card size: 66.5mm x 88mm (standard Gloomhaven card dimensions)
            const cardWidthMM = 66.5;
            const cardHeightMM = 88;

            // Base card size in pixels (same as preview)
            const baseW = 320, baseH = 423;
            // Scale factor to fit into mm dimensions at 96 DPI
            const printWpx = cardWidthMM * 96 / 25.4;
            const scale = printWpx / baseW;

            // Generate cards HTML using same structure as collection
            const cardsHtml = cards.map((c) => {
                const headerColor = c.colorHeader || '#808080';
                const flavorColor = c.colorFlavor || '#2a3a4a';
                const topActionColor = c.colorTopAction || '#4a5a6a';
                const bottomActionColor = c.colorBottomAction || '#1a2a3a';
                const hexInnerColor = c.colorHexInner || '#2a3a4a';
                const hexRimColor = c.colorHexRim || '#5a6a7a';
                const frameColor = c.colorFrame || '#4a4a4a';

                const bgStyle = `background: ${bottomActionColor}`;
                const topSectionStyle = `background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.12) 0%, transparent 50%), radial-gradient(ellipse at 70% 50%, rgba(255,255,255,0.06) 0%, transparent 40%), ${topActionColor}; border-top-color: ${hexRimColor}`;
                const bottomSectionStyle = `background: radial-gradient(ellipse at 50% 70%, rgba(0,0,0,0.15) 0%, transparent 50%), ${bottomActionColor}; margin-top: -1px`;
                const initSectionStyle = `background: linear-gradient(180deg, ${topActionColor} 0%, ${topActionColor} 50%, ${bottomActionColor} 50%, ${bottomActionColor} 100%); --class-header-dark: transparent; margin-top: -1px`;
                const flavorStyle = `background: ${flavorColor}`;
                const headerStyle = `background: linear-gradient(180deg, ${lightenColor(headerColor, 30)} 0%, ${headerColor} 20%, ${darkenColor(headerColor, 20)} 80%, ${darkenColor(headerColor, 40)} 100%)`;
                const sideBarStyle = `background: linear-gradient(180deg, ${lightenColor(headerColor, 20)} 0%, ${darkenColor(headerColor, 20)} 100%)`;
                const hexInnerGradient = `linear-gradient(180deg, ${lightenColor(hexInnerColor, 15)} 0%, ${hexInnerColor} 50%, ${darkenColor(hexInnerColor, 15)} 100%)`;
                const hexRimGradient = `linear-gradient(180deg, ${lightenColor(hexRimColor, 20)} 0%, ${hexRimColor} 50%, ${darkenColor(hexRimColor, 20)} 100%)`;
                const frameGradient = `linear-gradient(180deg, ${lightenColor(frameColor, 6)} 0%, ${darkenColor(frameColor, 5)} 15%, ${darkenColor(frameColor, 10)} 50%, ${darkenColor(frameColor, 5)} 85%, ${darkenColor(frameColor, 2)} 100%)`;
                const hexVars = `--hex-inner: ${hexInnerGradient}; --hex-rim: ${hexRimGradient}; --class-header-dark: ${hexRimColor}; --frame-gradient: ${frameGradient}`;

                const topAoeHtml = renderAoeHtml(c.aoeTop || [], 1);
                const bottomAoeHtml = renderAoeHtml(c.aoeBottom || [], 1);
                const topSummon = renderSummonHtml({enabled: c.topSummon, name: c.topSummonName, hp: c.topSummonHP, move: c.topSummonMove, attack: c.topSummonAttack, range: c.topSummonRange, special: c.topSummonSpecial, extra: c.topSummonExtra, image: c.topSummonImage}, 1);
                const bottomSummon = renderSummonHtml({enabled: c.bottomSummon, name: c.bottomSummonName, hp: c.bottomSummonHP, move: c.bottomSummonMove, attack: c.bottomSummonAttack, range: c.bottomSummonRange, special: c.bottomSummonSpecial, extra: c.bottomSummonExtra, image: c.bottomSummonImage}, 1);

                const topBonusVisible = c.topRoundBonus || c.topPersistent;
                const bottomBonusVisible = c.bottomRoundBonus || c.bottomPersistent;
                const topLossRight = getIconRightPosition(true, c.topLoss, topBonusVisible, 20, 35);
                const bottomLossRight = getIconRightPosition(true, c.bottomLoss, bottomBonusVisible, 20, 35);

                return `
                    <div class="print-card">
                        <div class="card ${c.cls}" style="${hexVars}">
                            <div class="card-bg" style="${bgStyle}"></div>
                            <div class="card-texture"></div>
                            <div class="card-overlay"></div>
                            <div class="card-frame"></div>
                            <div class="card-frame-bulge-left"></div>
                            <div class="card-frame-bulge-right"></div>
                            <div class="card-side-left" style="${sideBarStyle}"></div>
                            <div class="card-side-right" style="${sideBarStyle}"></div>
                            <div class="card-content">
                                <div class="card-header" style="${headerStyle}">
                                    <div class="header-row">
                                        <div class="level-hex"><span>${c.level}</span></div>
                                        <div class="name-banner">
                                            <div class="card-name">${c.name}</div>
                                        </div>
                                        <div class="class-icon">${CLASS_ICONS[c.cls] ? '<img src="assets/assets/classes/' + CLASS_ICONS[c.cls] + '" alt="' + c.cls + '">' : ''}</div>
                                    </div>
                                </div>
                                <div class="flavor-text${!c.flavor || !c.flavor.trim() ? ' hidden' : ''}" style="${flavorStyle}">${parseFormatting(c.flavor || '', 1)}</div>
                                <div class="ability-section top" style="${topSectionStyle}">
                                    ${topSummon.header}
                                    ${topSummon.box}
                                    ${topSummon.extra}
                                    <div class="ability-text" ${topSummon.hideAbility ? 'style="display:none"' : ''}>${parse(c.top, 1, 1)}</div>
                                    <div class="aoe-container">${topAoeHtml}</div>
                                    <img class="ability-indicator loss ${c.topLoss ? 'visible' : ''}" style="right:${topLossRight}px" src="assets/assets/lost.png" alt="loss">
                                    <img class="ability-indicator round-bonus ${c.topRoundBonus ? 'visible' : ''}" style="right:20px" src="assets/assets/round_bonus.png" alt="round bonus">
                                    <img class="ability-indicator persistent ${c.topPersistent ? 'visible' : ''}" style="right:20px" src="assets/assets/persistent_bonus.png" alt="persistent">
                                </div>
                                <div class="initiative-section" style="${initSectionStyle}">
                                    <div class="side-value"><span>${c.leftVal || ''}</span></div>
                                    <div class="initiative-main">
                                        <span class="initiative-value">${c.initiative}</span>
                                    </div>
                                    <div class="side-value"><span>${c.rightVal || ''}</span></div>
                                </div>
                                <div class="ability-section bottom" style="${bottomSectionStyle}">
                                    ${bottomSummon.header}
                                    ${bottomSummon.box}
                                    ${bottomSummon.extra}
                                    <div class="ability-text" ${bottomSummon.hideAbility ? 'style="display:none"' : ''}>${parse(c.bottom, 1, 1)}</div>
                                    <div class="aoe-container">${bottomAoeHtml}</div>
                                    <img class="ability-indicator loss ${c.bottomLoss ? 'visible' : ''}" style="right:${bottomLossRight}px" src="assets/assets/lost.png" alt="loss">
                                    <img class="ability-indicator round-bonus ${c.bottomRoundBonus ? 'visible' : ''}" style="right:20px" src="assets/assets/round_bonus.png" alt="round bonus">
                                    <img class="ability-indicator persistent ${c.bottomPersistent ? 'visible' : ''}" style="right:20px" src="assets/assets/persistent_bonus.png" alt="persistent">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Get current page's styles
            const styles = document.querySelector('style').innerHTML;

            printWindow.document.write('<!DOCTYPE html><html><head><title>Gloomhaven Cards - Print</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Pirata+One&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write('.print-container { visibility: hidden; } .fonts-loaded .print-container { visibility: visible; }');
            printWindow.document.write(styles);
            printWindow.document.write('* { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }');
            printWindow.document.write('@page { size: A4; margin: 10mm; }');
            printWindow.document.write('body { margin: 0; padding: 10mm; background: white; }');
            printWindow.document.write('.print-container { display: grid; grid-template-columns: repeat(3, ' + cardWidthMM + 'mm); gap: 3mm; justify-content: start; }');
            printWindow.document.write('.print-card { width: ' + cardWidthMM + 'mm; height: ' + cardHeightMM + 'mm; page-break-inside: avoid; break-inside: avoid; overflow: hidden; }');
            printWindow.document.write('.print-card .card { width: ' + baseW + 'px; height: ' + baseH + 'px; transform: scale(' + scale + '); transform-origin: top left; box-shadow: none; }');
            printWindow.document.write('.instructions { margin-bottom: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; font-family: sans-serif; color: #000; }');
            printWindow.document.write('.instructions h2 { margin: 0 0 10px 0; } .instructions p { margin: 5px 0; }');
            printWindow.document.write('.instructions button { margin-top: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; background: #4a7c59; color: white; border: none; border-radius: 4px; }');
            printWindow.document.write('@media print { .instructions { display: none; } }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write('<div class="instructions"><h2>Print Your Cards</h2>');
            printWindow.document.write('<p>Cards are sized at <strong>' + cardWidthMM + 'mm  ' + cardHeightMM.toFixed(1) + 'mm</strong></p>');
            printWindow.document.write('<p>Use "Save as PDF" or print with "Actual size" (100% scale, not fit-to-page).</p>');
            printWindow.document.write('<p>Enable "Print backgrounds" in print settings.</p>');
            printWindow.document.write('<button onclick="window.print()">Print / Save as PDF</button></div>');
            printWindow.document.write('<div class="print-container">' + cardsHtml + '</div>');
            printWindow.document.write('<script>document.fonts.ready.then(function(){document.body.classList.add("fonts-loaded");});setTimeout(function(){document.body.classList.add("fonts-loaded");},2000);<\/script>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
        }

        // exportPDF now uses print-based export
        function exportPDF() {
            exportPrint();
        }

        async function legacyExportPDF() {
            if (!cards.length) { alert('Add cards to collection first'); return; }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('portrait', 'mm', 'a4');

            // Gloomhaven card dimensions: 66.5mm x 88mm
            const cardW = 66.5, cardH = 88, margin = 10, gap = 3;
            const perRow = 3, perPage = 9;

            // Render at higher pixel resolution for print quality (300 DPI)
            // 66.5mm at 300 DPI = 785px, 88mm at 300 DPI = 1039px
            const renderW = 785, renderH = 1039;

            // Create render container - visible but off-screen for proper CSS computation
            const renderContainer = document.createElement('div');
            renderContainer.style.cssText = `
                position: fixed;
                left: -10000px;
                top: 0;
                width: ${renderW}px;
                background: transparent;
                font-family: 'Crimson Text', Georgia, serif;
            `;
            document.body.appendChild(renderContainer);

            for (let i = 0; i < cards.length; i++) {
                if (i > 0 && i % perPage === 0) pdf.addPage();
                const pi = i % perPage;
                const x = margin + (pi % perRow) * (cardW + gap);
                const y = margin + Math.floor(pi / perRow) * (cardH + gap);

                const c = cards[i];

                // PDF view: 47px bonus icons, 40px loss icons, 47px base right (to avoid frame bulge)
                const pdfTopBonusVisible = c.topRoundBonus || c.topPersistent;
                const pdfBottomBonusVisible = c.bottomRoundBonus || c.bottomPersistent;
                const pdfTopLossRight = getIconRightPosition(true, c.topLoss, pdfTopBonusVisible, 47, 82);
                const pdfBottomLossRight = getIconRightPosition(true, c.bottomLoss, pdfBottomBonusVisible, 47, 82);

                // Generate color styles for PDF
                const headerColor = c.colorHeader || '#808080';
                const flavorColor = c.colorFlavor || '#2a3a4a';
                const topActionColor = c.colorTopAction || '#4a5a6a';
                const bottomActionColor = c.colorBottomAction || '#1a2a3a';
                const hexInnerColor = c.colorHexInner || '#2a3a4a';
                const hexRimColor = c.colorHexRim || '#5a6a7a';
                const frameColor = c.colorFrame || '#4a4a4a';

                const pdfDarkerHeader = darkenColor(headerColor, 20);
                const pdfBgStyle = `inset: 28px; background: ${bottomActionColor}`;
                const pdfTopSectionStyle = `background: radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.12) 0%, transparent 50%), radial-gradient(ellipse at 70% 50%, rgba(255,255,255,0.06) 0%, transparent 40%), ${topActionColor}`;
                const pdfBottomSectionStyle = `background: radial-gradient(ellipse at 50% 70%, rgba(0,0,0,0.15) 0%, transparent 50%), ${bottomActionColor}; margin-top: -1px`;
                const pdfInitSectionStyle = `background: linear-gradient(180deg, ${topActionColor} 0%, ${topActionColor} 50%, ${bottomActionColor} 50%, ${bottomActionColor} 100%); --class-header-dark: transparent; margin-top: -1px`;
                const pdfFlavorStyle = `background: ${flavorColor}`;
                const pdfHeaderStyle = `padding: 14px 23px; margin: -23px -28px 0 -28px; border-radius: 0; background: linear-gradient(180deg, ${lightenColor(headerColor, 30)} 0%, ${headerColor} 20%, ${darkenColor(headerColor, 20)} 80%, ${darkenColor(headerColor, 40)} 100%)`;
                const pdfHexInnerGradient = `linear-gradient(180deg, ${lightenColor(hexInnerColor, 15)} 0%, ${hexInnerColor} 50%, ${darkenColor(hexInnerColor, 15)} 100%)`;
                const pdfHexRimGradient = `linear-gradient(180deg, ${lightenColor(hexRimColor, 20)} 0%, ${hexRimColor} 50%, ${darkenColor(hexRimColor, 20)} 100%)`;
                const pdfFrameGradient = `linear-gradient(180deg, ${lightenColor(frameColor, 15)} 0%, ${lightenColor(frameColor, 5)} 15%, ${frameColor} 50%, ${lightenColor(frameColor, 5)} 85%, ${lightenColor(frameColor, 10)} 100%)`;
                const pdfHexVars = `--hex-inner: ${pdfHexInnerGradient}; --hex-rim: ${pdfHexRimGradient}; --class-header-dark: ${pdfDarkerHeader}; --frame-gradient: ${pdfFrameGradient}`;

                // Render summon data for PDF (with larger scale)
                const pdfTopSummonData = {
                    enabled: c.topSummon,
                    name: c.topSummonName,
                    hp: c.topSummonHP,
                    move: c.topSummonMove,
                    attack: c.topSummonAttack,
                    range: c.topSummonRange,
                    special: c.topSummonSpecial,
                    extra: c.topSummonExtra,
                    image: c.topSummonImage
                };
                const pdfBottomSummonData = {
                    enabled: c.bottomSummon,
                    name: c.bottomSummonName,
                    hp: c.bottomSummonHP,
                    move: c.bottomSummonMove,
                    attack: c.bottomSummonAttack,
                    range: c.bottomSummonRange,
                    special: c.bottomSummonSpecial,
                    extra: c.bottomSummonExtra,
                    image: c.bottomSummonImage
                };
                const pdfTopSummon = renderSummonHtml(pdfTopSummonData, 2.34);
                const pdfBottomSummon = renderSummonHtml(pdfBottomSummonData, 2.34);

                // Create high-resolution card for PDF export with scaled Gloomhaven style
                const cardEl = document.createElement('div');
                cardEl.className = 'card ' + c.cls;
                cardEl.style.cssText = `
                    width: ${renderW}px;
                    height: ${renderH}px;
                    border-radius: 18px;
                    box-shadow: none;
                    ${pdfHexVars}
                `;
                cardEl.innerHTML = `
                    <div class="card-bg" style="inset: 23px 19px; background: ${bottomActionColor}"></div>
                    <div class="card-texture" style="inset: 0;"></div>
                    <div class="card-overlay" style="inset: 0;"></div>
                    <div class="card-frame" style="border-radius: 14px;"></div>
                    <div class="card-side-left" style="width: 28px; top: 10%; bottom: 10%; background: linear-gradient(180deg, ${lightenColor(headerColor, 20)} 0%, ${darkenColor(headerColor, 20)} 100%);"></div>
                    <div class="card-side-right" style="width: 28px; top: 10%; bottom: 10%; background: linear-gradient(180deg, ${lightenColor(headerColor, 20)} 0%, ${darkenColor(headerColor, 20)} 100%);"></div>
                    <div class="card-content" style="padding: 23px 28px 23px 28px;">
                        <div class="card-header" style="${pdfHeaderStyle}">
                            <div class="header-row" style="gap: 18px;">
                                <div class="level-hex" style="width: 60px; height: 60px;">
                                    <span style="font-size: 28px;">${c.level}</span>
                                </div>
                                <div class="name-banner">
                                    <div class="card-name" style="font-size: 35px; letter-spacing: 2px;">${c.name}</div>
                                </div>
                                <div class="class-icon" style="width: 56px; height: 56px; border-radius: 7px;">${CLASS_ICONS[c.cls] ? `<img src="assets/assets/classes/${CLASS_ICONS[c.cls]}" alt="${c.cls}">` : ''}</div>
                            </div>
                        </div>
                        <div class="flavor-text${!c.flavor || !c.flavor.trim() ? ' hidden' : ''}" style="padding: 18px 51px; margin: 0 -28px; font-size: 25px; ${pdfFlavorStyle}">${parseFormatting(c.flavor || '', 2.34)}</div>
                        <div class="ability-section top" style="padding: 28px 51px; margin: 0 -28px; ${pdfTopSectionStyle};${c.flavor && c.flavor.trim() ? ` border-top: 2px solid ${pdfDarkerHeader};` : ''}">
                            ${pdfTopSummon.header ? pdfTopSummon.header.replace('class="summon-header"', 'class="summon-header" style="font-size: 30px; margin-bottom: 14px;"') : ''}
                            ${pdfTopSummon.box ? pdfTopSummon.box.replace('class="summon-box visible"', 'class="summon-box visible" style="padding: 14px; margin: 9px 0; border-width: 5px;"').replace(/class="summon-portrait"/g, 'class="summon-portrait" style="width: 130px; height: 130px;"').replace(/class="summon-stats"/g, 'class="summon-stats" style="gap: 5px; padding: 7px;"').replace(/class="summon-stat"/g, 'class="summon-stat" style="padding: 5px 9px; gap: 7px;"').replace(/class="summon-stat"><img/g, 'class="summon-stat" style="padding: 5px 9px; gap: 7px;"><img style="width: 32px; height: 32px;"').replace(/<span>/g, '<span style="font-size: 30px;">').replace(/class="stat-box"/g, 'class="stat-box" style="width: 18px; height: 18px;"').replace(/class="summon-special"/g, 'class="summon-special" style="width: 130px; font-size: 21px;"') : ''}
                            ${pdfTopSummon.extra ? pdfTopSummon.extra.replace('class="summon-extra-text"', 'class="summon-extra-text" style="font-size: 28px; margin-top: 14px;"') : ''}
                            <div class="ability-text" style="font-size: 32px; line-height: 1.5;${pdfTopSummon.hideAbility ? ' display: none;' : ''}">${parse(c.top, 1, 2.34)}</div>
                            <div class="aoe-container">${renderAoeHtml(c.aoeTop || [], 2.34)}</div>
                            <img class="ability-indicator loss ${c.topLoss ? 'visible' : ''}" style="width: 51px; height: 51px; right: ${pdfTopLossRight}px; bottom: 9px;" src="assets/assets/lost.png" alt="loss">
                            <img class="ability-indicator round-bonus ${c.topRoundBonus ? 'visible' : ''}" style="width: 103px; height: 51px; right: 47px; bottom: 9px;" src="assets/assets/round_bonus.png" alt="round bonus">
                            <img class="ability-indicator persistent ${c.topPersistent ? 'visible' : ''}" style="width: 84px; height: 51px; right: 47px; bottom: 9px;" src="assets/assets/persistent_bonus.png" alt="persistent">
                        </div>
                        <div class="initiative-section" style="padding: 9px 28px; margin: 0 -28px; ${pdfInitSectionStyle}">
                            <div class="side-value" style="width: 75px; height: 84px; font-size: 28px;"><span>${c.leftVal || ''}</span></div>
                            <div class="initiative-main" style="width: 120px; height: 120px; margin: 0 18px;">
                                <span class="initiative-value" style="font-size: 56px;">${c.initiative}</span>
                            </div>
                            <div class="side-value" style="width: 75px; height: 84px; font-size: 28px;"><span>${c.rightVal || ''}</span></div>
                        </div>
                        <div class="ability-section bottom" style="padding: 28px 51px; margin: 0 -28px -23px -28px; ${pdfBottomSectionStyle}">
                            ${pdfBottomSummon.header ? pdfBottomSummon.header.replace('class="summon-header"', 'class="summon-header" style="font-size: 30px; margin-bottom: 14px;"') : ''}
                            ${pdfBottomSummon.box ? pdfBottomSummon.box.replace('class="summon-box visible"', 'class="summon-box visible" style="padding: 14px; margin: 9px 0; border-width: 5px;"').replace(/class="summon-portrait"/g, 'class="summon-portrait" style="width: 130px; height: 130px;"').replace(/class="summon-stats"/g, 'class="summon-stats" style="gap: 5px; padding: 7px;"').replace(/class="summon-stat"/g, 'class="summon-stat" style="padding: 5px 9px; gap: 7px;"').replace(/class="summon-stat"><img/g, 'class="summon-stat" style="padding: 5px 9px; gap: 7px;"><img style="width: 32px; height: 32px;"').replace(/<span>/g, '<span style="font-size: 30px;">').replace(/class="stat-box"/g, 'class="stat-box" style="width: 18px; height: 18px;"').replace(/class="summon-special"/g, 'class="summon-special" style="width: 130px; font-size: 21px;"') : ''}
                            ${pdfBottomSummon.extra ? pdfBottomSummon.extra.replace('class="summon-extra-text"', 'class="summon-extra-text" style="font-size: 28px; margin-top: 14px;"') : ''}
                            <div class="ability-text" style="font-size: 32px; line-height: 1.5;${pdfBottomSummon.hideAbility ? ' display: none;' : ''}">${parse(c.bottom, 1, 2.34)}</div>
                            <div class="aoe-container">${renderAoeHtml(c.aoeBottom || [], 2.34)}</div>
                            <img class="ability-indicator loss ${c.bottomLoss ? 'visible' : ''}" style="width: 51px; height: 51px; right: ${pdfBottomLossRight}px; bottom: 9px;" src="assets/assets/lost.png" alt="loss">
                            <img class="ability-indicator round-bonus ${c.bottomRoundBonus ? 'visible' : ''}" style="width: 103px; height: 51px; right: 47px; bottom: 9px;" src="assets/assets/round_bonus.png" alt="round bonus">
                            <img class="ability-indicator persistent ${c.bottomPersistent ? 'visible' : ''}" style="width: 84px; height: 51px; right: 47px; bottom: 9px;" src="assets/assets/persistent_bonus.png" alt="persistent">
                        </div>
                    </div>
                `;
                renderContainer.appendChild(cardEl);

                // Wait for images to load
                await new Promise(resolve => setTimeout(resolve, 50));

                try {
                    const canvas = await html2canvas(cardEl, {
                        scale: 1,
                        backgroundColor: null,
                        useCORS: true,
                        logging: false,
                        width: renderW,
                        height: renderH
                    });
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, cardW, cardH);
                } catch (err) {
                    console.error('Error rendering card:', err);
                }

                renderContainer.removeChild(cardEl);
            }

            document.body.removeChild(renderContainer);
            pdf.save('gloomhaven-rpg-cards.pdf');
        }

        // Initialize
        update();
    </script>
</body>
</html>
